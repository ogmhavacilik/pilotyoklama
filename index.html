<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title> UÇUŞ VE EĞİTİM ŞUBE YOKLAMA</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              forest: {
                50: '#f2fcf5',
                100: '#e1f8e8',
                200: '#c3eed0',
                300: '#94e0ad',
                400: '#5ccb83',
                500: '#35af61',
                600: '#258f4d',
                700: '#20723f',
                800: '#1e5b35',
                900: '#194b2e',
                950: '#0b2918',
              }
            },
            animation: {
                'fade-in': 'fadeIn 0.5s ease-in-out',
                'slide-up': 'slideUp 1s ease-in-out forwards',
                'slide-down': 'slideDown 0.5s ease-in-out',
            },
            keyframes: {
                fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                slideUp: { '0%': { transform: 'translateY(0)' }, '100%': { transform: 'translateY(-100%)' } },
                slideDown: { '0%': { transform: 'translateY(-20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
            }
          }
        }
      }
    </script>
    
    <!-- Custom Styles -->
    <style>
      body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow-x: hidden; }
      ::-webkit-scrollbar { width: 8px; height: 8px; }
      ::-webkit-scrollbar-track { background: #0b2918; }
      ::-webkit-scrollbar-thumb { background: #1e5b35; border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: #258f4d; }
    </style>

    <!-- React & Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Import Maps for Modules -->
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom": "https://esm.sh/react-dom@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "lucide-react": "https://esm.sh/lucide-react@0.292.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.1/",
    "react/": "https://aistudiocdn.com/react@^19.2.1/",
    "xlsx": "https://esm.sh/xlsx@^0.18.5"
  }
}
</script>
</head>
<body class="bg-forest-800 min-h-screen text-forest-50 font-sans antialiased selection:bg-forest-500 selection:text-white">
    <div id="root"></div>

    <script type="text/babel" data-type="module" data-presets="react">
        import React, { useState, useEffect, useCallback, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import * as LucideIcons from 'lucide-react';

        // --- TYPES (Converted to JS Objects/Constants for Runtime) ---
        const Role = {
            PILOT: 'Pilot',
            TECHNICIAN: 'Teknisyen',
            OBSERVER: 'Gözlemci',
            DRIVER: 'Şoför',
            CLEANING: 'Temizlik',
            KITCHEN: 'Yemekhane',
            TEA_SERVICE: 'Çaycı',
            UAV_OPERATOR: 'İHA Operatörü',
            OTHER: 'Diğer'
        };

        const AircraftModel = {
            BELL_429: 'BELL-429',
            AT_802: 'AT-802',
            C_650: 'C-650',
            B_360: 'B-360',
            T_70: 'T-70',
            IDARI_BIRIM: 'İDARİ BİRİM',
            YER_DESTEK: 'YER DESTEK',
            TEKNIK_EKIP: 'TEKNİK EKİP'
        };

        const AircraftCategory = {
            HELICOPTER: 'Helikopter',
            PLANE: 'Uçak',
            TECHNICAL: 'Teknik',
            GROUND: 'Yer Destek',
            ADMINISTRATIVE: 'İdari'
        };

        const AttendanceStatus = {
            PRESENT: 'Mesai', 
            ABSENT: 'Yok',
            LEAVE: 'İzin', 
            SICK: 'Rapor', 
            DUTY: 'Görev', 
            COURSE: 'Kurs',
            HOSPITAL: 'Hastane',
            PUBLIC_HOLIDAY: 'İdari İzin', 
            OTHER: 'Diğer'
        };

        const LeaveType = {
            DAILY: 'G.İ',
            OVERTIME: 'F.M.İ',
            HALF_OVERTIME: 'Y.F.M.İ',
            ANNUAL: 'Yİ',
            EXCUSE: 'M.İ',
            HALF_DAY: 'Y.G.İ'
        };

        const DutyType = {
            PLANNED: 'Planlı',
            UNPLANNED: 'Plansız'
        };

        const YONETIM_NAMES = ["MEHMET SEFA YÜCEDAĞ", "TEZCAN GÜZER", "ALPER ÖZMETİN"];

        // --- CONSTANTS ---
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyIQ6K0ZdK3vLB5tlAui5Ud2xgBAsOU22NuLssllXahkfH53fqERaki3uV1FRBA9hsN/exec"; 

        const CITIES = ['Adana', 'Adıyaman', 'Afyonkarahisar', 'Ağrı', 'Amasya', 'Ankara', 'Antalya', 'Artvin', 'Aydın', 'Balıkesir', 'Bilecik', 'Bingöl', 'Bitlis', 'Bolu', 'Burdur', 'Bursa', 'Çanakkale', 'Çankırı', 'Çorum', 'Denizli', 'Diyarbakır', 'Edirne', 'Elazığ', 'Erzincan', 'Erzurum', 'Eskişehir', 'Gaziantep', 'Giresun', 'Gümüşhane', 'Hakkari', 'Hatay', 'Isparta', 'Mersin', 'İstanbul', 'İzmir', 'Kars', 'Kastamonu', 'Kayseri', 'Kırklareli', 'Kırşehir', 'Kocaeli', 'Konya', 'Kütahya', 'Malatya', 'Manisa', 'Kahramanmaraş', 'Mardin', 'Muğla', 'Muş', 'Nevşehir', 'Niğde', 'Ordu', 'Rize', 'Sakarya', 'Samsun', 'Siirt', 'Sinop', 'Sivas', 'Tekirdağ', 'Tokat', 'Trabzon', 'Tunceli', 'Şanlıurfa', 'Uşak', 'Van', 'Yozgat', 'Zonguldak', 'Aksaray', 'Bayburt', 'Karaman', 'Kırıkkale', 'Batman', 'Şırnak', 'Bartın', 'Ardahan', 'Iğdır', 'Yalova', 'Karabük', 'Kilis', 'Osmaniye', 'Düzce'];

        const AIRCRAFT_SPECIFIC_CITIES = {
            [AircraftModel.AT_802]: ['Çanakkale', 'Milas', 'Balıkesir/ Edremit', 'İzmir /Efes', 'Bursa', 'Antalya'],
            [AircraftModel.T_70]: ['Muğla/Güvercinlik', 'Muğla/Yanıklar'],
            [AircraftModel.BELL_429]: ['Çanakkale', 'İzmir', 'Muğla', 'Antalya', 'Ankara'],
            [AircraftModel.B_360]: ['Ankara', 'İstanbul', 'İzmir', 'Antalya', 'Dalaman', 'Muğla', 'Çanakkale', 'Adana'],
            [AircraftModel.C_650]: ['Ankara', 'İstanbul', 'İzmir', 'Antalya', 'Dalaman', 'Muğla', 'Çanakkale', 'Adana']
        };

        const PERSONNEL_TITLES = [
            'AT-802 PİLOT', 'BELL-429 PİLOT', 'C-650 PİLOT', 'B-360 PİLOT', 'T-70 PİLOT', 
            'AT-802 TEKNİSYEN', 'BELL-429 TEKNİSYEN', 'C-650 TEKNİSYEN', 'T-70 TEKNİSYEN', 'UÇAK TEKNİSYENİ', 'UÇAK TEKNİKERİ', 'B-360 TEKNİSYEN', 'MÜHENDİS', 'MEMUR', 'DESTEK MEMUR', 'DESTEK MEMUR(ŞÖFÖR)', 'İŞÇİ'
        ];

        const DEFAULT_START_DATE = '2023-01-01';

        const INITIAL_AIRCRAFT = [
            { id: '1', tailNumber: 'OR-0177', model: AircraftModel.C_650, category: AircraftCategory.PLANE, city: 'Ankara' },
            { id: '2', tailNumber: 'OR-1839', model: AircraftModel.B_360, category: AircraftCategory.PLANE, city: 'Ankara' },
            { id: '3', tailNumber: 'OR-3125', model: AircraftModel.BELL_429, category: AircraftCategory.HELICOPTER, city: 'Antalya' },
            { id: '4', tailNumber: 'OR-3126', model: AircraftModel.BELL_429, category: AircraftCategory.HELICOPTER, city: 'Muğla' },
            { id: '5', tailNumber: 'OR-3127', model: AircraftModel.BELL_429, category: AircraftCategory.HELICOPTER, city: 'Ankara' },
            { id: '6', tailNumber: 'OR-3131', model: AircraftModel.BELL_429, category: AircraftCategory.HELICOPTER, city: 'Ankara' },
            { id: '7', tailNumber: 'OR-3133', model: AircraftModel.BELL_429, category: AircraftCategory.HELICOPTER, city: 'Ankara' },
            { id: '8', tailNumber: 'OR-3192', model: AircraftModel.BELL_429, category: AircraftCategory.HELICOPTER, city: 'İzmir' },
            { id: '9', tailNumber: 'OR-1018', model: AircraftModel.T_70, category: AircraftCategory.HELICOPTER, city: 'Ankara' },
            { id: '10', tailNumber: 'OR-1019', model: AircraftModel.T_70, category: AircraftCategory.HELICOPTER, city: 'Ankara' },
            { id: '11', tailNumber: 'OR-1020', model: AircraftModel.T_70, category: AircraftCategory.HELICOPTER, city: 'Ankara' },
            { id: '12', tailNumber: 'OR-2021', model: AircraftModel.AT_802, category: AircraftCategory.PLANE, city: 'Ankara' },
            { id: '13', tailNumber: 'OR-2022', model: AircraftModel.AT_802, category: AircraftCategory.PLANE, city: 'Ankara' },
            { id: '14', tailNumber: 'OR-2023', model: AircraftModel.AT_802, category: AircraftCategory.PLANE, city: 'Ankara' },
            { id: '15', tailNumber: 'OR-2024', model: AircraftModel.AT_802, category: AircraftCategory.PLANE, city: 'Ankara' },
            { id: '16', tailNumber: 'OR-2025', model: AircraftModel.AT_802, category: AircraftCategory.PLANE, city: 'Ankara' },
            { id: '17', tailNumber: 'OR-2026', model: AircraftModel.AT_802, category: AircraftCategory.PLANE, city: 'Ankara' },
            { id: '18', tailNumber: 'OR-2036', model: AircraftModel.AT_802, category: AircraftCategory.PLANE, city: 'Ankara' },
            { id: '19', tailNumber: 'OR-2038', model: AircraftModel.AT_802, category: AircraftCategory.PLANE, city: 'Ankara' },
            { id: '20', tailNumber: 'OR-2027', model: AircraftModel.AT_802, category: AircraftCategory.PLANE, city: 'Ankara' },
            { id: '21', tailNumber: 'OR-2028', model: AircraftModel.AT_802, category: AircraftCategory.PLANE, city: 'Ankara' },
            { id: '22', tailNumber: 'OR-2029', model: AircraftModel.AT_802, category: AircraftCategory.PLANE, city: 'Ankara' },
            { id: '23', tailNumber: 'OR-2037', model: AircraftModel.AT_802, category: AircraftCategory.PLANE, city: 'Ankara' },
            { id: '24', tailNumber: 'MERKEZ', model: AircraftModel.TEKNIK_EKIP, category: AircraftCategory.TECHNICAL, city: 'Ankara' },
            { id: '25', tailNumber: 'DESTEK', model: AircraftModel.YER_DESTEK, category: AircraftCategory.GROUND, city: 'Ankara' },
            { id: '26', tailNumber: 'İDARİ', model: AircraftModel.IDARI_BIRIM, category: AircraftCategory.ADMINISTRATIVE, city: 'Ankara' },
        ];

        const INITIAL_PERSONNEL = [
            { id: 'p1', fullName: 'RIFAT ÖNAL', role: Role.PILOT, title: 'BELL-429 PİLOT', city: 'Ankara', activeFrom: '2023-01-01', rank: 1 },
            { id: 'p2', fullName: 'SABRİ AKSOY', role: Role.PILOT, title: 'BELL-429 PİLOT', city: 'Ankara', activeFrom: '2023-01-01', rank: 2 },
            { id: 'p3', fullName: 'HAKAN KOZLU (MUĞLA)', role: Role.PILOT, title: 'BELL-429 PİLOT', city: 'Muğla', activeFrom: '2023-01-01', rank: 3 },
            { id: 'p4', fullName: 'GÜRHAN AYDIN (İZMİR)', role: Role.PILOT, title: 'BELL-429 PİLOT', city: 'İzmir', activeFrom: '2023-01-01', rank: 4 },
            { id: 'p5', fullName: 'SERHAT İVECAN (İZMİR)', role: Role.PILOT, title: 'BELL-429 PİLOT', city: 'İzmir', activeFrom: '2023-01-01', rank: 5 },
            { id: 'p6', fullName: 'YÜCEL KIVRAK (ANTALYA)', role: Role.PILOT, title: 'BELL-429 PİLOT', city: 'Antalya', activeFrom: '2023-01-01', rank: 6 },
            { id: 'p7', fullName: 'SUAT ÜNER', role: Role.PILOT, title: 'BELL-429 PİLOT', city: 'Ankara', activeFrom: '2023-01-01', rank: 7 },
            { id: 'p8', fullName: 'KADİR YILMAZ', role: Role.PILOT, title: 'BELL-429 PİLOT', city: 'Ankara', activeFrom: '2023-01-01', rank: 8 },
            { id: 'p9', fullName: 'BİLGE ERDOĞAN (MUĞLA)', role: Role.PILOT, title: 'BELL-429 PİLOT', city: 'Muğla', activeFrom: '2023-01-01', rank: 9 },
            { id: 'p10', fullName: 'ADEM BİLGİN (ANTALYA)', role: Role.PILOT, title: 'BELL-429 PİLOT', city: 'Antalya', activeFrom: '2023-01-01', rank: 10 },
            { id: 'p11', fullName: 'N.GÖKMEN GEÇER', role: Role.PILOT, title: 'BELL-429 PİLOT', city: 'Ankara', activeFrom: '2023-01-01', rank: 11 },
            { id: 'p12', fullName: 'FETHİ ŞAHBAZ', role: Role.PILOT, title: 'BELL-429 PİLOT', city: 'Ankara', activeFrom: '2023-01-01', rank: 12 },
            { id: 'p13', fullName: 'FATİH ŞAHİN', role: Role.PILOT, title: 'BELL-429 PİLOT', city: 'Ankara', activeFrom: '2023-01-01', rank: 13 },
            { id: 'p14', fullName: 'BORA KOÇ', role: Role.PILOT, title: 'BELL-429 PİLOT', city: 'Ankara', activeFrom: '2023-01-01', rank: 14 },
            { id: 'p15', fullName: 'BURHAN GÜLER', role: Role.PILOT, title: 'AT-802 PİLOT', city: 'Ankara', activeFrom: '2023-01-01', rank: 15 },
            { id: 'p16', fullName: 'MURAT AKMEŞE', role: Role.PILOT, title: 'C-650 PİLOT', city: 'Ankara', activeFrom: '2023-01-01', rank: 16 },
            { id: 'p17', fullName: 'ALPER GİDER', role: Role.PILOT, title: 'AT-802 PİLOT', city: 'Ankara', activeFrom: '2023-01-01', rank: 17 },
            { id: 'p18', fullName: 'ERHAN BARAN', role: Role.PILOT, title: 'T-70 PİLOT', city: 'Ankara', activeFrom: '2023-01-01', rank: 18 },
            { id: 'p19', fullName: 'YILMAZ MAMUNLUOĞLU', role: Role.PILOT, title: 'C-650 PİLOT', city: 'Ankara', activeFrom: '2023-01-01', rank: 19 },
            { id: 'p20', fullName: 'AYDINER TÜTÜNCÜOĞLU', role: Role.PILOT, title: 'B-360 PİLOT', city: 'Ankara', activeFrom: '2023-01-01', rank: 20 },
            { id: 'p21', fullName: 'MURAT ÖZÇAKMAK', role: Role.PILOT, title: 'T-70 PİLOT', city: 'Ankara', activeFrom: '2023-01-01', rank: 21 },
            { id: 'p22', fullName: 'EMRAH YETİŞİR', role: Role.PILOT, title: 'T-70 PİLOT', city: 'Ankara', activeFrom: '2023-01-01', rank: 22 },
            { id: 'p23', fullName: 'MEHMET HOCAOĞLU', role: Role.PILOT, title: 'T-70 PİLOT', city: 'Ankara', activeFrom: '2023-01-01', rank: 23 },
            { id: 'p24', fullName: 'ALTAN ALKAN SÖZEN', role: Role.PILOT, title: 'B-360 PİLOT', city: 'Ankara', activeFrom: '2023-01-01', rank: 24 },
            { id: 'p25', fullName: 'OSMAN AKTAŞ', role: Role.PILOT, title: 'AT-802 PİLOT', city: 'Ankara', activeFrom: '2023-01-01', rank: 25 },
            { id: 'p26', fullName: 'İBRAHİM İSMİHAN ERSUN', role: Role.PILOT, title: 'T-70 PİLOT', city: 'Ankara', activeFrom: '2023-01-01', rank: 26 },
            { id: 'p27', fullName: 'SERDAR ÜNLÜYOL', role: Role.PILOT, title: 'T-70 PİLOT', city: 'Ankara', activeFrom: '2023-01-01', rank: 27 },
            { id: 'p28', fullName: 'HAKAN BİNİCİ', role: Role.PILOT, title: 'T-70 PİLOT', city: 'Ankara', activeFrom: '2023-01-01', rank: 28 },
            { id: 'p29', fullName: 'KAĞAN BASKAK', role: Role.PILOT, title: 'AT-802 PİLOT', city: 'Ankara', activeFrom: '2023-01-01', rank: 29 },
            { id: 'p30', fullName: 'HALİL İBRAHİM CENGİZ', role: Role.PILOT, title: 'BELL-429 PİLOT', city: 'Ankara', activeFrom: '2023-01-01', rank: 30 },
            { id: 'p31', fullName: 'ATAKAN TANSÜYER', role: Role.PILOT, title: 'AT-802 PİLOT', city: 'Ankara', activeFrom: '2023-01-01', rank: 31 },
            { id: 'p32', fullName: 'MUZAFFER BARIŞ COŞAR', role: Role.PILOT, title: 'AT-802 PİLOT', city: 'Ankara', activeFrom: '2023-01-01', rank: 32 },
            { id: 'p33', fullName: 'ERSEN YILMAZ', role: Role.PILOT, title: 'BELL-429 PİLOT', city: 'Ankara', activeFrom: '2023-01-01', rank: 33 },
            { id: 'p34', fullName: 'CENGİZ ÖZDEMİR', role: Role.PILOT, title: 'B-360 PİLOT', city: 'Ankara', activeFrom: '2023-01-01', rank: 34 },
            { id: 'p35', fullName: 'MUSTAFA SEVİNÇ', role: Role.PILOT, title: 'T-70 PİLOT', city: 'Ankara', activeFrom: '2023-01-01', rank: 35 },
            { id: 'p36', fullName: 'RAMAZAN AKKAŞ', role: Role.PILOT, title: 'T-70 PİLOT', city: 'Ankara', activeFrom: '2023-01-01', rank: 36 },
            { id: 'p37', fullName: 'ÖMER BÖLÜKBAŞI', role: Role.PILOT, title: 'BELL-429 PİLOT', city: 'Ankara', activeFrom: '2023-01-01', rank: 37 },
            { id: 'p38', fullName: 'MUSTAFA YİĞİT GÜMÜŞ', role: Role.PILOT, title: 'T-70 PİLOT', city: 'Ankara', activeFrom: '2023-01-01', rank: 38 },
            { id: 'p39', fullName: 'ÜMİT KÖKCÜ', role: Role.PILOT, title: 'T-70 PİLOT', city: 'Ankara', activeFrom: '2023-01-01', rank: 39 },
            { id: 'p40', fullName: 'CEM KARAHAN', role: Role.PILOT, title: 'T-70 PİLOT', city: 'Ankara', activeFrom: '2023-01-01', rank: 40 },
            { id: 'p41', fullName: 'ŞENER TURAN', role: Role.PILOT, title: 'AT-802 PİLOT', city: 'Ankara', activeFrom: '2023-01-01', rank: 41 },
            { id: 'p42', fullName: 'SERDAR KADEMLİOĞLU', role: Role.PILOT, title: 'AT-802 PİLOT', city: 'Ankara', activeFrom: '2023-01-01', rank: 42 },
            { id: 'p43', fullName: 'ABDULLAH OKTAY AY', role: Role.PILOT, title: 'AT-802 PİLOT', city: 'Ankara', activeFrom: '2023-01-01', rank: 43 },
            { id: 'p44', fullName: 'MUSTAFA ALP', role: Role.PILOT, title: 'AT-802 PİLOT', city: 'Ankara', activeFrom: '2023-01-01', rank: 44 },
            { id: 'p45', fullName: 'AYDINER ÇILDIR', role: Role.PILOT, title: 'AT-802 PİLOT', city: 'Ankara', activeFrom: '2023-01-01', rank: 45 },
            { id: 'p46', fullName: 'MEHMET AKİF BOZKURT', role: Role.PILOT, title: 'AT-802 PİLOT', city: 'Ankara', activeFrom: '2023-01-01', rank: 46 },
            { id: 'p47', fullName: 'OSMAN UZUNER', role: Role.PILOT, title: 'AT-802 PİLOT', city: 'Ankara', activeFrom: '2023-01-01', rank: 47 },
            { id: 'p48', fullName: 'DEVRİM FERHAT ÇALIŞKAN', role: Role.PILOT, title: 'B-360 PİLOT', city: 'Ankara', activeFrom: '2023-01-01', rank: 48 },
            { id: 'p49', fullName: 'HİKMET DUMAN', role: Role.PILOT, title: 'BELL-429 PİLOT', city: 'Ankara', activeFrom: '2023-01-01', rank: 49 },
            { id: 'p50', fullName: 'SERKAN KEBABCI', role: Role.PILOT, title: 'B-360 PİLOT', city: 'Ankara', activeFrom: '2023-01-01', rank: 50 },
            { id: 'p51', fullName: 'ŞÜKRAN AKKAN DEMİR', role: Role.OTHER, title: 'MEMUR', city: 'Ankara', activeFrom: '2023-01-01', unit: 'İDARİ BİRİM', rank: 51 }
        ];

        // --- SERVICES ---
        const normalizeDate = (d) => {
            if (!d) return '';
            if (d instanceof Date) {
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            if (typeof d === 'string') {
                if (d.includes('T')) return d.split('T')[0];
                if (/^\d{4}-\d{2}-\d{2}$/.test(d)) return d;
                if (d.length >= 10) return d.substring(0, 10);
            }
            return '';
        };

        const localData = {
            getAircraft: () => JSON.parse(localStorage.getItem('ogm_aircraft') || JSON.stringify(INITIAL_AIRCRAFT)),
            saveAircraft: (d) => localStorage.setItem('ogm_aircraft', JSON.stringify(d)),
            getPersonnel: () => JSON.parse(localStorage.getItem('ogm_personnel') || JSON.stringify(INITIAL_PERSONNEL)),
            savePersonnel: (d) => localStorage.setItem('ogm_personnel', JSON.stringify(d)),
            getAttendance: () => JSON.parse(localStorage.getItem('ogm_attendance') || '[]'),
            setAttendance: (data) => localStorage.setItem('ogm_attendance', JSON.stringify(data)),
            saveAttendance: (newRecords) => {
                const existing = localData.getAttendance();
                const others = existing.filter(e => !newRecords.some(n => n.personId === e.personId && n.date === e.date));
                const merged = [...others, ...newRecords];
                localStorage.setItem('ogm_attendance', JSON.stringify(merged));
                return merged;
            }
        };

        const memoryCache = {
            aircraft: null,
            personnel: null,
            attendance: null,
            loaded: false
        };

        const apiCall = async (action, payload = {}) => {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 15000); 
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    redirect: 'follow',
                    body: JSON.stringify({ action, ...payload }),
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                const json = await response.json();
                if (!json.success) throw new Error(json.error || 'API Error');
                return json.data;
            } catch (error) {
                clearTimeout(timeoutId);
                throw error;
            }
        };

        const storageService = {
            preload: async () => {
                try {
                    const data = await apiCall('get_init_data');
                    if (data.aircraft) {
                        const formattedAC = data.aircraft.map(a => ({ ...a, id: String(a.id) }));
                        localData.saveAircraft(formattedAC);
                        memoryCache.aircraft = formattedAC;
                    }
                    if (data.personnel) {
                        let formattedPL = data.personnel.map(p => ({ ...p, id: String(p.id) }));
                        
                        // MERGE LOGIC: Add missing INITIAL_PERSONNEL
                        INITIAL_PERSONNEL.forEach(initP => {
                            if (!formattedPL.some(p => p.id === initP.id)) {
                                formattedPL.push(initP);
                            }
                        });

                        // Sort by rank
                        formattedPL.sort((a, b) => (a.rank || 999) - (b.rank || 999));

                        localData.savePersonnel(formattedPL);
                        memoryCache.personnel = formattedPL;
                    }

                    const att = await apiCall('get_attendance');
                    const formattedAtt = att.map(r => ({
                        ...r,
                        id: String(r.id),
                        personId: String(r.personId),
                        date: normalizeDate(r.date),
                        // Migration: Normalize 'İzinli' to 'İzin' and 'Mevcut' to 'Mesai' for old records
                        status: r.status === 'İzinli' ? 'İzin' : (r.status === 'Mevcut' ? 'Mesai' : r.status)
                    }));

                    localData.setAttendance(formattedAtt);
                    memoryCache.attendance = formattedAtt;
                    memoryCache.loaded = true;
                } catch (e) {
                    console.warn("Preload failed, using local", e);
                    memoryCache.aircraft = localData.getAircraft();
                    memoryCache.personnel = localData.getPersonnel();
                    memoryCache.attendance = localData.getAttendance();
                    memoryCache.loaded = true;
                }
            },
            refresh: async () => {
                memoryCache.loaded = false;
                await storageService.preload();
            },
            getAttendanceSync: () => memoryCache.attendance || localData.getAttendance(),
            getPersonnelSync: () => memoryCache.personnel || localData.getPersonnel(),
            getAircraft: async () => {
                if (!memoryCache.loaded) await storageService.preload();
                return memoryCache.aircraft || localData.getAircraft();
            },
            saveAircraft: async (data) => {
                localData.saveAircraft(data);
                memoryCache.aircraft = data;
                try { await apiCall('save_aircraft', { aircraft: data }); } catch (e) { }
            },
            getPersonnel: async () => {
                if (!memoryCache.loaded) await storageService.preload();
                return memoryCache.personnel || localData.getPersonnel();
            },
            savePersonnel: async (data) => {
                localData.savePersonnel(data);
                memoryCache.personnel = data;
                try { await apiCall('save_personnel', { personnel: data }); } catch (e) { }
            },
            getAttendance: async () => {
                if (!memoryCache.loaded) await storageService.preload();
                return memoryCache.attendance || localData.getAttendance();
            },
            saveAttendance: async (data) => {
                const updatedFullList = localData.saveAttendance(data);
                memoryCache.attendance = updatedFullList;
                apiCall('save_attendance', { records: data }).catch(e => console.error("BG Save fail", e));
                return updatedFullList;
            }
        };

        // --- COMPONENTS ---

        // Button Component
        const Button = ({ variant = 'primary', size = 'md', className = '', children, ...props }) => {
            const v = {
                primary: 'bg-forest-500 hover:bg-forest-400 text-white',
                secondary: 'bg-forest-800 border border-forest-600 hover:bg-forest-700 text-white',
                danger: 'bg-red-600 hover:bg-red-500 text-white',
                success: 'bg-green-600 hover:bg-green-500 text-white'
            }[variant];

            const s = {
                sm: 'px-2 py-1 text-xs',
                md: 'px-4 py-2 text-sm',
                lg: 'px-6 py-3 text-base'
            }[size];

            return (
                <button className={`inline-flex items-center justify-center font-medium rounded-md transition-colors ${s} ${v} ${className}`} {...props}>
                    {children}
                </button>
            );
        };

        // Card Component
        const Card = ({ children, title, className = '' }) => (
            <div className={`bg-forest-900 border border-forest-700 shadow-xl rounded-lg overflow-hidden ${className}`}>
                {title && (
                    <div className="bg-forest-950 px-4 py-3 border-b border-forest-700 font-semibold text-forest-50">
                        {title}
                    </div>
                )}
                <div className="p-4">{children}</div>
            </div>
        );

        // Icons
        const { 
            ShieldCheck, Menu, X, LogOut, Plane, Fan, Truck, Wrench, Settings, 
            Trash2, XCircle, ArrowUp, ArrowDown, UserMinus, MapPin, Search, 
            AlertCircle, Users, Globe, Calendar, MessageSquare, CheckCircle, 
            BarChart3, Activity, FileText, Loader2, Plus, Edit2, MoreVertical, 
            CalendarDays, Lock 
        } = LucideIcons;

        const ModelIcon = ({ category, model, className }) => {
            if (model === AircraftModel.IDARI_BIRIM) return <Users className={className} />;
            if (model === AircraftModel.YER_DESTEK) return <Truck className={className} />;
            if (model === AircraftModel.TEKNIK_EKIP) return <Wrench className={className} />;
            if (category === AircraftCategory.HELICOPTER) return <Fan className={className} />;
            if (category === AircraftCategory.GROUND) return <Truck className={className} />;
            if (category === AircraftCategory.TECHNICAL) return <Wrench className={className} />;
            return <Plane className={className} />;
        };

        // AttendanceControl Component
        const AttendanceControl = ({ personId, state, isWeeklyMode, aircraftModel, onChangeStatus, onChangeDetail }) => {
            const status = state?.status;
            const currentCities = AIRCRAFT_SPECIFIC_CITIES[aircraftModel] || CITIES;

            return (
                <div className="flex flex-col xl:flex-row items-start xl:items-center gap-4 w-full">
                    <div className="flex flex-wrap gap-2 w-full xl:w-auto">
                        <button onClick={() => onChangeStatus(personId, AttendanceStatus.PRESENT)} className={`px-3 py-1.5 text-xs sm:text-sm border rounded-md transition-all flex-grow sm:flex-grow-0 ${status === AttendanceStatus.PRESENT ? 'bg-green-600 border-green-500 text-white' : 'bg-forest-900 border-forest-700 text-forest-400 hover:border-forest-500'}`}>
                            Mesai
                        </button>

                        <button onClick={() => onChangeStatus(personId, AttendanceStatus.DUTY)} className={`px-3 py-1.5 text-xs sm:text-sm border rounded-md transition-all flex-grow sm:flex-grow-0 ${status === AttendanceStatus.DUTY ? 'bg-blue-600 border-blue-500 text-white' : 'bg-forest-900 border-forest-700 text-forest-400 hover:border-forest-500'}`}>
                            Görev
                        </button>
                         <button onClick={() => onChangeStatus(personId, AttendanceStatus.COURSE)} className={`px-3 py-1.5 text-xs sm:text-sm border rounded-md transition-all flex-grow sm:flex-grow-0 ${status === AttendanceStatus.COURSE ? 'bg-blue-600 border-blue-500 text-white' : 'bg-forest-900 border-forest-700 text-forest-400 hover:border-forest-500'}`}>
                            Kurs
                        </button>

                        {[AttendanceStatus.LEAVE, AttendanceStatus.SICK, AttendanceStatus.HOSPITAL].map((s) => {
                            const isSelected = status === s;
                            let activeClass = '';
                            if (isSelected) {
                                if (s === AttendanceStatus.LEAVE) activeClass = 'bg-yellow-600 border-yellow-500 text-white';
                                else if (s === AttendanceStatus.HOSPITAL) activeClass = 'bg-pink-600 border-pink-500 text-white';
                                else activeClass = 'bg-red-500 border-red-400 text-white';
                            } else {
                                activeClass = 'bg-forest-900 border-forest-700 text-forest-400 hover:border-forest-500';
                            }
                            return (
                                <button key={s} onClick={() => onChangeStatus(personId, s)} className={`px-3 py-1.5 text-xs sm:text-sm border rounded-md transition-all flex-grow sm:flex-grow-0 ${activeClass}`}>
                                    {s}
                                </button>
                            );
                        })}

                        <button
                            onClick={() => onChangeStatus(personId, AttendanceStatus.PUBLIC_HOLIDAY)}
                            className={`px-3 py-1.5 text-xs sm:text-sm border rounded-md transition-all flex-grow sm:flex-grow-0 ${status === AttendanceStatus.PUBLIC_HOLIDAY
                                    ? 'bg-orange-600 border-orange-500 text-white'
                                    : 'bg-forest-900 border-forest-700 text-forest-400 hover:border-forest-500'
                                }`}
                        >
                            İdari İzin
                        </button>

                        <button
                            onClick={() => onChangeStatus(personId, AttendanceStatus.OTHER)}
                            className={`px-3 py-1.5 text-xs sm:text-sm border rounded-md transition-all flex-grow sm:flex-grow-0 ${status === AttendanceStatus.OTHER
                                    ? 'bg-purple-600 border-purple-500 text-white'
                                    : 'bg-forest-900 border-forest-700 text-forest-400 hover:border-forest-500'
                                }`}
                        >
                            Diğer
                        </button>

                         <button onClick={() => onChangeStatus(personId, AttendanceStatus.ABSENT)} className={`px-3 py-1.5 text-xs sm:text-sm border rounded-md transition-all flex-grow sm:flex-grow-0 ${status === AttendanceStatus.ABSENT ? 'bg-red-600 border-red-500 text-white' : 'bg-forest-900 border-forest-700 text-forest-400 hover:border-forest-500'}`}>
                            Yok
                        </button>
                    </div>

                    {status === AttendanceStatus.DUTY && (
                        <div className="w-full flex flex-col gap-2 animate-fade-in bg-forest-900/50 p-2 rounded border border-blue-500/30">
                            <div className="flex flex-wrap items-center gap-4 text-xs text-forest-300 px-1">
                                <label className="flex items-center gap-1 cursor-pointer">
                                    <input type="radio" checked={state?.dutyType !== DutyType.UNPLANNED} onChange={() => onChangeDetail(personId, 'dutyType', DutyType.PLANNED)} className="accent-forest-500" /> Planlı
                                </label>
                                <label className="flex items-center gap-1 cursor-pointer">
                                    <input type="radio" checked={state?.dutyType === DutyType.UNPLANNED} onChange={() => onChangeDetail(personId, 'dutyType', DutyType.UNPLANNED)} className="accent-forest-500" /> Plansız
                                </label>
                                
                                {isWeeklyMode && state?.dutyType !== DutyType.UNPLANNED && (
                                    <label className="flex items-center gap-1 cursor-pointer bg-forest-800 px-2 py-0.5 rounded border border-forest-600 ml-auto hover:bg-forest-700 transition-colors">
                                        <input 
                                            type="checkbox" 
                                            checked={!!state?.includeWeekend} 
                                            onChange={(e) => onChangeDetail(personId, 'includeWeekend', e.target.checked)} 
                                            className="accent-forest-500 w-4 h-4" 
                                        /> 
                                        <span className="text-white font-bold">Hafta sonu dahil</span>
                                    </label>
                                )}
                            </div>
                            <div className="flex items-center gap-2">
                                <Globe size={16} className="text-blue-400 flex-shrink-0" />
                                {state?.dutyType === DutyType.UNPLANNED ? (
                                    <input 
                                        type="text" 
                                        placeholder="Görev yerini manuel giriniz" 
                                        className="bg-forest-800 border border-forest-600 text-white text-xs rounded p-1.5 w-full focus:ring-blue-500 focus:border-blue-500" 
                                        value={state?.dutyLocation || ''} 
                                        onChange={(e) => onChangeDetail(personId, 'dutyLocation', e.target.value)} 
                                    />
                                ) : (
                                    <select
                                        className="bg-forest-800 border border-forest-600 text-white text-xs rounded p-1.5 w-full focus:ring-blue-500 focus:border-blue-500"
                                        value={(!state?.dutyLocation) ? "" : ((state.dutyLocation === 'DİĞER' || currentCities.includes(state.dutyLocation)) ? state.dutyLocation : 'DİĞER')}
                                        onChange={(e) => {
                                            const val = e.target.value;
                                            onChangeDetail(personId, 'dutyLocation', val);
                                        }}
                                    >
                                        <option value="" disabled>Görev Yeri Seç</option>
                                        {currentCities.map(c => <option key={c} value={c}>{c}</option>)}
                                        <option value="DİĞER">DİĞER</option>
                                    </select>
                                )}
                            </div>
                            {(state?.dutyType !== DutyType.UNPLANNED) && (state?.dutyLocation === 'DİĞER' || (state?.dutyLocation && !currentCities.includes(state.dutyLocation))) && (
                                <input type="text" placeholder="Yer giriniz" className="bg-forest-800 border border-forest-600 text-white text-xs rounded p-1.5 w-full focus:ring-blue-500 focus:border-blue-500 animate-slide-down" value={state.dutyLocation === 'DİĞER' ? '' : state.dutyLocation} onChange={(e) => onChangeDetail(personId, 'dutyLocation', e.target.value === '' ? 'DİĞER' : e.target.value)} />
                            )}
                        </div>
                    )}

                    {status === AttendanceStatus.COURSE && (
                        <div className="w-full flex flex-col gap-2 animate-fade-in bg-forest-900/50 p-2 rounded border border-indigo-500/30">
                            <div className="flex items-center gap-4 text-xs text-forest-300 px-1">
                                <label className="flex items-center gap-1 cursor-pointer"><input type="radio" checked={!state?.isInt} onChange={() => onChangeDetail(personId, 'isInt', false)} className="accent-forest-500" /> Yurt İçi</label>
                                <label className="flex items-center gap-1 cursor-pointer"><input type="radio" checked={!!state?.isInt} onChange={() => onChangeDetail(personId, 'isInt', true)} className="accent-forest-500" /> Yurt Dışı</label>
                            </div>
                            <div className="flex items-center gap-2">
                                <Globe size={16} className="text-indigo-400 flex-shrink-0" />
                                {!state?.isInt ? (
                                    <select className="bg-forest-800 border border-forest-600 text-white text-xs rounded p-1.5 w-full focus:ring-indigo-500 focus:border-indigo-500" value={currentCities.includes(state?.dutyLocation || '') ? state?.dutyLocation : ''} onChange={(e) => onChangeDetail(personId, 'dutyLocation', e.target.value)}><option value="" disabled>İl Seçiniz</option>{currentCities.map(c => <option key={c} value={c}>{c}</option>)}</select>
                                ) : (
                                    <input type="text" placeholder="Ülke / Şehir" className="bg-forest-800 border border-forest-600 text-white text-xs rounded p-1.5 w-full focus:ring-indigo-500 focus:border-indigo-500" value={state?.dutyLocation || ''} onChange={(e) => onChangeDetail(personId, 'dutyLocation', e.target.value)} />
                                )}
                            </div>
                        </div>
                    )}

                    {status === AttendanceStatus.LEAVE && (
                        <div className="w-full flex items-center gap-2 animate-fade-in bg-forest-900/50 p-2 rounded border border-yellow-500/30">
                            <Calendar size={16} className="text-yellow-400 flex-shrink-0" />
                            <select className="bg-forest-800 border border-forest-600 text-white text-xs rounded p-1.5 flex-grow focus:ring-yellow-500 focus:border-yellow-500" value={state?.leaveType || LeaveType.DAILY} onChange={(e) => onChangeDetail(personId, 'leaveType', e.target.value)}>
                                <option value={LeaveType.DAILY}>Günlük İzin (G.İ)</option>
                                <option value={LeaveType.OVERTIME}>Fazla Mesai İzni (F.M.İ)</option>
                                <option value={LeaveType.HALF_OVERTIME}>Yarım Gün F.M.İ (Y.F.M.İ)</option>
                                <option value={LeaveType.ANNUAL}>Yıllık İzin (Yİ)</option>
                                <option value={LeaveType.EXCUSE}>Mazeret İzni (M.İ)</option>
                                <option value={LeaveType.HALF_DAY}>Yarım Gün İzin (Y.G.İ)</option>
                            </select>
                            {isWeeklyMode && state?.leaveType === LeaveType.OVERTIME && (
                                <label className="flex-shrink-0 flex items-center gap-1 cursor-pointer bg-forest-800 px-2 py-0.5 rounded border border-forest-600 hover:bg-forest-700 transition-colors">
                                    <input 
                                        type="checkbox" 
                                        checked={!!state?.includeWeekend} 
                                        onChange={(e) => onChangeDetail(personId, 'includeWeekend', e.target.checked)} 
                                        className="accent-forest-500 w-4 h-4" 
                                    /> 
                                    <span className="text-white font-bold text-xs">H.Sonu</span>
                                </label>
                            )}
                        </div>
                    )}

                    {status === AttendanceStatus.OTHER && (
                        <div className="w-full flex items-center gap-2 animate-fade-in bg-forest-900/50 p-2 rounded border border-purple-500/30">
                            <MessageSquare size={16} className="text-purple-400 flex-shrink-0" />
                            <input type="text" placeholder="Açıklama giriniz..." className="bg-forest-800 border border-forest-600 text-white text-xs rounded p-1.5 w-full focus:ring-purple-500 focus:border-purple-500" value={state?.note || ''} onChange={(e) => onChangeDetail(personId, 'note', e.target.value)} />
                        </div>
                    )}
                </div>
            );
        };

        // AdminPanel Component
        const AdminPanel = ({ onLogout }) => {
            const [tab, setTab] = useState('aircraft');
            const [acList, setAcList] = useState([]);
            const [plList, setPlList] = useState([]);
            const [notification, setNotification] = useState(null);
            const [loading, setLoading] = useState(false);

            // Aircraft Form State
            const [acForm, setAcForm] = useState({ id: null, model: '', cat: AircraftCategory.HELICOPTER, tail: 'OR-', city: 'Ankara' });
            
            // Personnel Form State
            const [plForm, setPlForm] = useState({ id: null, name: '', role: Role.PILOT, city: 'Ankara', title: '', start: new Date().toLocaleDateString('en-CA'), unit: '' });
            const [manualTitle, setManualTitle] = useState(false);

            // Modals
            const [deleteModalOpen, setDeleteModalOpen] = useState(false);
            const [personToDelete, setPersonToDelete] = useState(null);
            const [terminationDate, setTerminationDate] = useState('');

            useEffect(() => {
                setLoading(true);
                Promise.all([
                    storageService.getAircraft().then(setAcList),
                    storageService.getPersonnel().then(p => setPlList(p.sort((a, b) => (a.rank || 999) - (b.rank || 999))))
                ]).finally(() => setLoading(false));
            }, []);

            const showNotify = (msg) => {
                setNotification(msg);
                setTimeout(() => setNotification(null), 3000);
            };

            const uniqueModels = useMemo(() => {
                const models = [...new Set(acList.map(a => a.model))].filter(m => m && m.length > 1);
                // Add YÖNETİM manually if not in list
                if (!models.includes('YÖNETİM')) models.push('YÖNETİM');
                return models.sort();
            }, [acList]);

            const saveAc = async () => {
                if (!acForm.model || !acForm.tail) return;
                setLoading(true);
                try {
                    let list = [...acList];
                    if (acForm.id) list = list.map(x => x.id === acForm.id ? { ...x, model: acForm.model, category: acForm.cat, tailNumber: acForm.tail, city: acForm.city } : x);
                    else list.push({ id: Date.now().toString(), model: acForm.model, category: acForm.cat, tailNumber: acForm.tail, city: acForm.city });
                    await storageService.saveAircraft(list);
                    setAcList(list);
                    setAcForm({ id: null, model: '', cat: AircraftCategory.HELICOPTER, tail: 'OR-', city: 'Ankara' });
                    showNotify("Hava aracı kaydedildi.");
                } finally {
                    setLoading(false);
                }
            };

            const deleteAc = async (id, e) => {
                e.preventDefault();
                e.stopPropagation();
                
                const ac = acList.find(x => x.id === id);
                if (!ac) return;

                if (window.confirm(`${ac.tailNumber} kuyruk nolu ${ac.model} aracını silmek istediğinize emin misiniz?`)) {
                    setLoading(true);
                    try {
                        const list = acList.filter(x => x.id !== id);
                        await storageService.saveAircraft(list);
                        setAcList(list);
                        showNotify("Hava aracı silindi.");
                    } catch(e) {
                        console.error(e);
                        alert("Silme işlemi başarısız oldu.");
                    } finally {
                        setLoading(false);
                    }
                }
            };

            const savePl = async () => {
                if (!plForm.name) return;
                setLoading(true);
                try {
                    let list = [...plList];
                    const pData = { fullName: plForm.name, role: plForm.role, city: plForm.city, title: plForm.title, activeFrom: plForm.start, unit: plForm.unit };
                    if (plForm.id) list = list.map(x => x.id === plForm.id ? { ...x, ...pData } : x);
                    else list.push({ id: Date.now().toString(), ...pData, rank: (Math.max(...list.map(x => x.rank || 0), 0) + 1) });
                    await storageService.savePersonnel(list);
                    setPlList(list);
                    setPlForm({ id: null, name: '', role: Role.PILOT, city: 'Ankara', title: '', start: new Date().toLocaleDateString('en-CA'), unit: '' });
                    setManualTitle(false);
                    showNotify("Personel kaydedildi.");
                } finally {
                    setLoading(false);
                }
            };

            const initiateDeletePerson = (p) => {
                setPersonToDelete(p);
                setTerminationDate(new Date().toLocaleDateString('en-CA'));
                setDeleteModalOpen(true);
            };

            const terminatePerson = async () => {
                if (!personToDelete) return;
                setLoading(true);
                try {
                    const list = plList.map(p => p.id === personToDelete.id ? { ...p, activeUntil: terminationDate } : p);
                    await storageService.savePersonnel(list);
                    setPlList(list);
                    setDeleteModalOpen(false);
                    setPersonToDelete(null);
                    showNotify("Personel arşivlendi (İşten çıkarıldı).");
                } catch(e) {
                    console.error(e);
                    alert("İşlem başarısız oldu.");
                } finally {
                    setLoading(false);
                }
            };

            const hardDeletePerson = async () => {
                if (!personToDelete) return;
                if (window.confirm(`${personToDelete.fullName} isimli personelin kaydını TAMAMEN silmek üzeresiniz. Bu işlem geri alınamaz. Onaylıyor musunuz?`)) {
                    setLoading(true);
                    try {
                        const list = plList.filter(p => p.id !== personToDelete.id);
                        await storageService.savePersonnel(list);
                        setPlList(list);
                        setDeleteModalOpen(false);
                        setPersonToDelete(null);
                        showNotify("Personel kaydı tamamen silindi.");
                    } catch(e) {
                        console.error(e);
                        alert("Silme işlemi başarısız oldu.");
                    } finally {
                        setLoading(false);
                    }
                }
            };

            const movePl = async (idx, dir) => {
                const list = [...plList];
                const tIdx = dir === 'up' ? idx - 1 : idx + 1;
                if (tIdx < 0 || tIdx >= list.length) return;
                
                // Optimistic UI update
                const temp = list[idx].rank;
                list[idx].rank = list[tIdx].rank;
                list[tIdx].rank = temp;
                [list[idx], list[tIdx]] = [list[tIdx], list[idx]];
                setPlList(list);
                
                // Background save
                storageService.savePersonnel(list).catch(() => {
                    alert("Sıralama kaydedilemedi.");
                });
            };

            const exportPersonnelCsv = () => {
                let csv = '\uFEFFSIRA;AD SOYAD;UNVAN;BİRİM;BÖLGE\n';
                plList.forEach((p, i) => {
                    csv += `${i + 1};"${p.fullName}";"${p.title || p.role}";"${p.unit || ''}";"${p.city}"\n`;
                });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
                link.download = 'Personel_Listesi.csv';
                link.click();
            };

            if (loading) return (
                <div className="fixed inset-0 bg-black/80 z-50 flex flex-col items-center justify-center">
                    <div className="w-64 h-64 mb-4 rounded-full border-8 border-forest-400 overflow-hidden shadow-[0_0_40px_rgba(0,0,0,0.6)]">
                        <img src="https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExNW9uenhqZXdxbGd6YWNxc2UwempmOXNyaG15NGtuZTJmb3EyaTNqZCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9cw/1rrxPs1nb3IjwmbiXw/giphy.gif" alt="Loading..." className="w-full h-full object-cover" />
                    </div>
                    <div className="text-white text-xl font-bold animate-pulse">Bekleyiniz</div>
                </div>
            );

            return (
                <div className="container mx-auto p-4 max-w-6xl relative">
                    {notification && (
                        <div className="absolute top-0 right-0 m-4 bg-green-600 text-white px-4 py-2 rounded shadow-lg animate-slide-down z-50 flex items-center">
                            <CheckCircle size={18} className="mr-2" /> {notification}
                        </div>
                    )}
                    <div className="flex justify-between mb-6">
                        <h2 className="text-2xl font-bold">Yönetici Paneli</h2>
                        <Button variant="secondary" onClick={onLogout}>
                            <LogOut className="mr-2" size={16} /> Çıkış
                        </Button>
                    </div>
                    <div className="flex gap-2 mb-6 border-b border-forest-600 pb-2">
                        <button onClick={() => setTab('aircraft')} className={`px-4 py-2 rounded ${tab === 'aircraft' ? 'bg-forest-600 text-white' : 'text-forest-300'}`}>Hava Araçları</button>
                        <button onClick={() => setTab('personnel')} className={`px-4 py-2 rounded ${tab === 'personnel' ? 'bg-forest-600 text-white' : 'text-forest-300'}`}>Personel</button>
                    </div>

                    {tab === 'aircraft' ? (
                        <div className="grid lg:grid-cols-3 gap-6">
                            <Card title={acForm.id ? "Düzenle" : "Ekle"} className="h-fit">
                                <div className="space-y-3">
                                    <input placeholder="Model (Örn: BELL-429)" className="w-full bg-forest-950 border border-forest-700 rounded p-2 text-white" value={acForm.model} onChange={e => setAcForm({ ...acForm, model: e.target.value })} />
                                    <div className="flex gap-1">
                                        <button onClick={() => setAcForm({ ...acForm, cat: AircraftCategory.HELICOPTER })} className={`flex-1 py-1 text-xs border ${acForm.cat === AircraftCategory.HELICOPTER ? 'bg-forest-500' : 'bg-forest-800'}`}>Helikopter</button>
                                        <button onClick={() => setAcForm({ ...acForm, cat: AircraftCategory.PLANE })} className={`flex-1 py-1 text-xs border ${acForm.cat === AircraftCategory.PLANE ? 'bg-forest-500' : 'bg-forest-800'}`}>Uçak</button>
                                    </div>
                                    <input placeholder="Kuyruk No" className="w-full bg-forest-950 border border-forest-700 rounded p-2 text-white" value={acForm.tail} onChange={e => setAcForm({ ...acForm, tail: e.target.value })} />
                                    <select className="w-full bg-forest-950 border border-forest-700 rounded p-2 text-white" value={acForm.city} onChange={e => setAcForm({ ...acForm, city: e.target.value })}>{CITIES.map(c => <option key={c}>{c}</option>)}</select>
                                    <div className="flex gap-2">
                                        <Button onClick={saveAc} className="flex-1">{acForm.id ? 'Güncelle' : 'Ekle'}</Button>
                                        {acForm.id && <Button variant="secondary" onClick={() => { setAcForm({ id: null, model: '', cat: AircraftCategory.HELICOPTER, tail: 'OR-', city: 'Ankara' }); }}>İptal</Button>}
                                    </div>
                                </div>
                            </Card>
                            <Card title="Filo Listesi" className="lg:col-span-2">
                                <div className="overflow-auto max-h-[600px]">
                                    <table className="w-full text-sm text-forest-200">
                                        <thead><tr className="text-left"><th className="p-2">Model</th><th className="p-2">Kuyruk</th><th className="p-2">Bölge</th><th className="p-2 text-right">İşlem</th></tr></thead>
                                        <tbody>
                                            {acList.map(a => (
                                                <tr key={a.id} className="border-b border-forest-700 hover:bg-forest-700/50 cursor-pointer" onDoubleClick={() => { setAcForm({ id: a.id, model: a.model, cat: a.category, tail: a.tailNumber, city: a.city }); }}>
                                                    <td className="p-2">{a.model}</td>
                                                    <td className="p-2">{a.tailNumber}</td>
                                                    <td className="p-2">{a.city}</td>
                                                    <td className="p-2 text-right">
                                                        <button onClick={(e) => deleteAc(a.id, e)} type="button" className="text-red-400 hover:text-red-300 p-2 relative z-10"><Trash2 size={16} /></button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </Card>
                        </div>
                    ) : (
                        <div className="grid lg:grid-cols-3 gap-6">
                            <Card title={plForm.id ? "Düzenle" : "Ekle"} className="h-fit">
                                <div className="space-y-3">
                                    <input placeholder="Ad Soyad" className="w-full bg-forest-950 border border-forest-700 rounded p-2 text-white" value={plForm.name} onChange={e => setPlForm({ ...plForm, name: e.target.value })} />
                                    <select 
                                        className="w-full bg-forest-950 border border-forest-700 rounded p-2 text-white" 
                                        value={manualTitle ? 'OTHER' : (plForm.title || '')} 
                                        onChange={e => {
                                            const val = e.target.value;
                                            let newRole = plForm.role;
                                            
                                            // Otomatik rol belirleme
                                            const valUpper = val.toLocaleUpperCase('tr-TR');
                                            if (valUpper.includes('Pilot')) newRole = Role.PILOT;
                                            else if (valUpper.includes('TEKNİSYEN') || valUpper.includes('TEKNİKER') || valUpper.includes('MÜHENDİS')) newRole = Role.TECHNICIAN;

                                            if (val === 'OTHER') { 
                                                setManualTitle(true); 
                                                setPlForm({ ...plForm, title: '', role: newRole });
                                            } else { 
                                                setManualTitle(false); 
                                                setPlForm({ ...plForm, title: val, role: newRole });
                                            }
                                        }}
                                    >
                                        <option value="">Unvan Seç</option>
                                        {PERSONNEL_TITLES.map(t => <option key={t} value={t}>{t}</option>)}
                                        <option value="OTHER">Diğer</option>
                                    </select>
                                    
                                    {manualTitle && <input placeholder="Unvan Giriniz" className="w-full bg-forest-950 border border-forest-700 rounded p-2 text-white" value={plForm.title} onChange={e => setPlForm({ ...plForm, title: e.target.value })} />}
                                    
                                    <select className="w-full bg-forest-950 border border-forest-700 rounded p-2 text-white" value={plForm.unit || ''} onChange={e => setPlForm({ ...plForm, unit: e.target.value })}>
                                        <option value="">Birim / Uçak Seçimi (Otomatik/Genel)</option>
                                        {uniqueModels.map(m => <option key={m} value={m}>{m}</option>)}
                                    </select>

                                    <select className="w-full bg-forest-950 border border-forest-700 rounded p-2 text-white" value={plForm.city} onChange={e => setPlForm({ ...plForm, city: e.target.value })}>{CITIES.map(c => <option key={c}>{c}</option>)}</select>
                                    <input type="date" className="w-full bg-forest-950 border border-forest-700 rounded p-2 text-white" value={plForm.start} onChange={e => setPlForm({ ...plForm, start: e.target.value })} />
                                    <div className="flex gap-2">
                                        <Button onClick={savePl} className="flex-1">{plForm.id ? 'Güncelle' : 'Ekle'}</Button>
                                        {plForm.id && <Button variant="secondary" onClick={() => { setPlForm({ id: null, name: '', role: Role.PILOT, city: 'Ankara', title: '', start: new Date().toLocaleDateString('en-CA'), unit: '' }); setManualTitle(false); }}>İptal</Button>}
                                    </div>
                                </div>
                            </Card>
                            <Card title="Personel Listesi" className="lg:col-span-2">
                                 <div className="flex justify-end mb-2">
                                     <Button onClick={exportPersonnelCsv} size="sm" variant="secondary" className="flex items-center gap-2"><FileText size={14} /> Excel İndir</Button>
                                 </div>
                                <div className="overflow-auto max-h-[600px]">
                                    <table className="w-full text-sm text-forest-200">
                                        <thead><tr className="text-left"><th className="p-2">Sıra</th><th className="p-2">Ad Soyad</th><th className="p-2">Unvan</th><th className="p-2">Birim</th><th className="p-2">Bölge</th><th className="p-2 text-right">İşlem</th></tr></thead>
                                        <tbody>
                                            {plList.map((p, i) => (
                                                <tr key={p.id} className={`border-b border-forest-700 hover:bg-forest-700/50 cursor-pointer ${p.activeUntil ? 'opacity-50' : ''}`} onDoubleClick={() => { setPlForm({ id: p.id, name: p.fullName, role: p.role, city: p.city, title: p.title || '', start: p.activeFrom || '', unit: p.unit || '' }); setManualTitle(!PERSONNEL_TITLES.includes(p.title || '')); }}>
                                                    <td className="p-2">{i + 1}</td>
                                                    <td className="p-2">{p.fullName}</td>
                                                    <td className="p-2 bg-forest-900/50"><span className="text-xs px-1 rounded bg-forest-800">{p.title || p.role}</span></td>
                                                    <td className="p-2">{p.unit || '-'}</td>
                                                    <td className="p-2">{p.city}</td>
                                                    <td className="p-2 text-right flex justify-end gap-1">
                                                        <button onClick={(e) => { e.stopPropagation(); movePl(i, 'up') }}><ArrowUp size={14} /></button>
                                                        <button onClick={(e) => { e.stopPropagation(); movePl(i, 'down') }}><ArrowDown size={14} /></button>
                                                        <button onClick={(e) => { e.stopPropagation(); initiateDeletePerson(p); }} type="button" className="text-red-400 ml-2 hover:bg-forest-800 rounded p-1 relative z-10"><Trash2 size={16} /></button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </Card>
                        </div>
                    )}

                    {deleteModalOpen && personToDelete && (
                        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50">
                            <div className="bg-forest-900 border border-forest-600 p-6 rounded-lg max-w-md w-full shadow-2xl">
                                <h3 className="text-xl font-bold text-white mb-2">Personel İşten Çıkarma</h3>
                                <p className="text-forest-300 text-sm mb-4"><span className="font-bold text-white">{personToDelete.fullName}</span></p>
                                <div className="mb-4">
                                    <label className="block text-xs uppercase text-forest-400 font-bold mb-1">Çıkış Tarihi</label>
                                    <input type="date" className="w-full bg-forest-950 border border-forest-700 rounded p-2 text-white" value={terminationDate} onChange={(e) => setTerminationDate(e.target.value)} />
                                </div>
                                <div className="flex flex-col gap-3">
                                    <Button variant="danger" type="button" onClick={terminatePerson} className="w-full"><UserMinus className="mr-2" size={16} /> İşten Çıkar (Arşivle)</Button>
                                    <Button variant="secondary" type="button" onClick={hardDeletePerson} className="w-full bg-red-900/30 text-red-300 border-red-900/50"><Trash2 className="mr-2" size={16} /> Kaydı Tamamen Sil</Button>
                                    <Button variant="secondary" type="button" onClick={() => { setDeleteModalOpen(false); setPersonToDelete(null); }} className="w-full mt-2">İptal</Button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // AttendanceView Component
        const getTodayString = () => {
            const d = new Date();
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const getDaysInRange = (start, end) => {
            const dates = [];
            const [sY, sM, sD] = start.split('-').map(Number);
            const [eY, eM, eD] = end.split('-').map(Number);
            
            const current = new Date(sY, sM - 1, sD, 12, 0, 0);
            const endObj = new Date(eY, eM - 1, eD, 12, 0, 0);

            while (current <= endObj) {
                dates.push(new Date(current));
                current.setDate(current.getDate() + 1);
            }
            return dates;
        };

        const AttendanceView = () => {
            const [selModel, setSelModel] = useState(null);
            const [rangeStartDate, setRangeStartDate] = useState(getTodayString());
            const [rangeEndDate, setRangeEndDate] = useState(getTodayString());
            
            const [models, setModels] = useState([]);
            const [inv, setInv] = useState([]);
            const [allRecs, setAllRecs] = useState([]);
            const [allPersonnel, setAllPersonnel] = useState([]);
            const [dashboardStatus, setDashboardStatus] = useState({});

            const [people, setPeople] = useState([]);
            const [att, setAtt] = useState({});
            const [loading, setLoading] = useState(true);

            // Tab State
            const [activeTab, setActiveTab] = useState('PILOT');

            // Modal
            const [detailModalOpen, setDetailModalOpen] = useState(false);
            const [detailPerson, setDetailPerson] = useState(null);
            const [detailDays, setDetailDays] = useState({});

            // Report
            const [dates, setDates] = useState({ start: getTodayString(), end: getTodayString() });
            const [isReportReady, setIsReportReady] = useState(false);
            const [reportUnit, setReportUnit] = useState('TÜM BİRİMLER');
            const [reportSearch, setReportSearch] = useState('');

            // Security States
            const [isEditUnlocked, setIsEditUnlocked] = useState(false);
            const [showUnlockModal, setShowUnlockModal] = useState(false);
            const [unlockPassword, setUnlockPassword] = useState('');
            const [pendingAction, setPendingAction] = useState(null);

            // Data Load
            const loadDashboardData = useCallback(async () => {
                const [ac, pl, [recs, syncedPl]] = await Promise.all([
                    storageService.getAircraft(),
                    storageService.getPersonnel(),
                    Promise.all([
                        storageService.getAttendanceSync(),
                        storageService.getPersonnelSync()
                    ])
                ]);

                // DATA MIGRATION: Remove old combined unit and ensure new ones exist
                let updatedAc = [...ac];
                const oldUnitIndex = updatedAc.findIndex(a => a.model === 'TEKNİK EKİP VE DESTEK');
                let modified = false;
                
                if (oldUnitIndex !== -1) {
                    updatedAc.splice(oldUnitIndex, 1);
                    modified = true;
                }
                
                if (!updatedAc.find(a => a.model === AircraftModel.IDARI_BIRIM)) {
                    updatedAc.push({ id: '26', tailNumber: 'İDARİ', model: AircraftModel.IDARI_BIRIM, category: AircraftCategory.ADMINISTRATIVE, city: 'Ankara' });
                    modified = true;
                }

                if (modified) {
                    storageService.saveAircraft(updatedAc);
                }

                setInv(updatedAc);
                const uniqueModels = [...new Set(updatedAc.map(a => a.model))].filter(m => m && m.length > 1 && m !== 'e').sort();
                setModels(uniqueModels);
                setAllPersonnel(syncedPl || pl);
                setAllRecs(recs || []);

                const finalPersonnel = syncedPl || pl;
                if (finalPersonnel.length > 0) {
                    const statusMap = {};
                    const today = getTodayString();
                    
                    const specificAircraftTags = uniqueModels
                        .filter(m => m !== AircraftModel.YER_DESTEK && m !== AircraftModel.TEKNIK_EKIP && m !== AircraftModel.IDARI_BIRIM)
                        .map(m => m.replace(/[^a-zA-Z0-9ğüşıöçĞÜŞİÖÇ]/g, '').toLocaleUpperCase('tr-TR'));

                    uniqueModels.forEach(m => {
                        const mNameNormalized = m.replace(/[^a-zA-Z0-9ğüşıöçĞÜŞİÖÇ]/g, '').toLocaleUpperCase('tr-TR');
                        
                        const relevantPersonnel = finalPersonnel.filter(p => {
                            // EXCLUDE MANAGEMENT NAMES FROM REGULAR AIRCRAFT LISTS
                            if (YONETIM_NAMES.includes(p.fullName)) return false;

                            const pStart = p.activeFrom || '2000-01-01';
                            const pEnd = p.activeUntil || '2099-12-31';
                            if (today < pStart || today > pEnd) return false;

                            // 1. PRIORITIZE EXPLICIT UNIT ASSIGNMENT
                            if (p.unit) {
                                return p.unit === m;
                            }

                            // 2. FALLBACK TO TITLE/ROLE MATCHING
                            const titleUpper = (p.title || '').toLocaleUpperCase('tr-TR');
                            const role = p.role;
                            const tClean = titleUpper.replace(/[^a-zA-Z0-9ğüşıöçĞÜŞİÖÇ]/g, '');

                            const belongsToSpecificAircraft = specificAircraftTags.some(tag => tClean.includes(tag));

                            if (m === AircraftModel.YER_DESTEK) {
                                if (p.fullName.includes('SERKAN KOTAN')) return true; // Force include SERKAN KOTAN
                                if (belongsToSpecificAircraft) return false; 
                                const isTechnicalRole = titleUpper.includes('UÇAK TEKNİ') || titleUpper.includes('MÜHENDİS');
                                if (isTechnicalRole) return false;

                                const isGroundRole = [Role.DRIVER, Role.CLEANING, Role.KITCHEN, Role.TEA_SERVICE, Role.OTHER].includes(role);
                                const isGroundTitle = titleUpper.includes('MEMUR') || titleUpper.includes('İŞÇİ') || titleUpper.includes('ŞÖFÖR');
                                return isGroundRole || isGroundTitle;
                            } else if (m === AircraftModel.TEKNIK_EKIP) {
                                if (p.fullName.includes('SERKAN KOTAN')) return false; // Force exclude SERKAN KOTAN
                                if (belongsToSpecificAircraft) return false;
                                return titleUpper.includes('UÇAK TEKNİ') || titleUpper.includes('MÜHENDİS');
                            } else if (m === AircraftModel.IDARI_BIRIM) {
                                return (titleUpper === 'MEMUR' || titleUpper.includes('İDARİ')) && !belongsToSpecificAircraft;
                            } else {
                                return tClean.includes(mNameNormalized);
                            }
                        });

                        const pilots = relevantPersonnel.filter(p => p.role === Role.PİLOT || (p.title && p.title.toLocaleUpperCase('tr-TR').includes('PİLOT')));
                        const techs = relevantPersonnel.filter(p => !pilots.includes(p));

                        const pilotDataExists = pilots.length > 0 && pilots.some(p => (recs || []).some(r => r.date === today && r.personId === p.id));
                        const techDataExists = techs.length > 0 && techs.some(p => (recs || []).some(r => r.date === today && r.personId === p.id));
                        const groundDataExists = relevantPersonnel.length > 0 && relevantPersonnel.some(p => (recs || []).some(r => r.date === today && r.personId === p.id));

                        const isGroundUnit = m === AircraftModel.YER_DESTEK;
                        const isTechnicalUnit = m === AircraftModel.TEKNIK_EKIP;
                        const isIdariUnit = m === AircraftModel.IDARI_BIRIM;

                        statusMap[m] = {
                            pilotMissing: !isGroundUnit && !isTechnicalUnit && !isIdariUnit && pilots.length > 0 && !pilotDataExists,
                            techMissing: (!isGroundUnit && !isIdariUnit && techs.length > 0 && !techDataExists) || (isTechnicalUnit && !techDataExists),
                            groundMissing: (isGroundUnit || isIdariUnit) && !groundDataExists
                        };
                    });

                    // Check YONETIM Status
                    const yonetimMembers = finalPersonnel.filter(p => YONETIM_NAMES.includes(p.fullName));
                    const yonetimHasData = yonetimMembers.some(p => (recs || []).some(r => r.date === today && r.personId === p.id));
                    statusMap['YÖNETİM'] = { missing: !yonetimHasData && yonetimMembers.length > 0 };

                    setDashboardStatus(statusMap);
                }
            }, []);

            useEffect(() => {
                setLoading(true);
                storageService.preload()
                    .then(() => loadDashboardData())
                    .then(() => setLoading(false))
                    .catch(e => {
                        console.error(e);
                        setLoading(false);
                    });
            }, [loadDashboardData]);

            const handleBackToDashboard = async () => {
                setLoading(true);
                try {
                    await storageService.refresh();
                    await loadDashboardData();
                    setSelModel(null);
                } catch (e) {
                    alert("Veriler güncellenirken bir hata oluştu, lütfen sayfayı yenileyiniz.");
                    console.error(e);
                    setSelModel(null);
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => {
                if (selModel) {
                    setLoading(true);
                    setActiveTab('PILOT');

                    if (selModel === 'YÖNETİM') {
                         const targetP = allPersonnel.filter(p => YONETIM_NAMES.includes(p.fullName)).sort((a, b) => (a.rank || 999) - (b.rank || 999));
                         setPeople(targetP);
                         setLoading(false);
                         return;
                    }

                    const specificAircraftTags = models
                        .filter(m => m !== AircraftModel.YER_DESTEK && m !== AircraftModel.TEKNIK_EKIP && m !== AircraftModel.IDARI_BIRIM)
                        .map(m => m.replace(/[^a-zA-Z0-9ğüşıöçĞÜŞİÖÇ]/g, '').toLocaleUpperCase('tr-TR'));

                    const targetP = allPersonnel.filter(p => {
                        // EXCLUDE MANAGEMENT NAMES FROM REGULAR AIRCRAFT LISTS
                        if (YONETIM_NAMES.includes(p.fullName)) return false;

                        const pStart = p.activeFrom || '2000-01-01';
                        const pEnd = p.activeUntil || '2099-12-31';
                        const isActiveInRange = pStart <= rangeEndDate && pEnd >= rangeStartDate;
                        
                        if (!isActiveInRange) return false;

                        // 1. PRIORITIZE EXPLICIT UNIT ASSIGNMENT
                        if (p.unit) {
                            return p.unit === selModel;
                        }

                        // 2. FALLBACK TO TITLE/ROLE MATCHING
                        const titleUpper = (p.title || '').toLocaleUpperCase('tr-TR');
                        const role = p.role;
                        const tClean = titleUpper.replace(/[^a-zA-Z0-9ğüşıöçĞÜŞİÖÇ]/g, '');

                        const belongsToSpecificAircraft = specificAircraftTags.some(tag => tClean.includes(tag));

                        if (selModel === AircraftModel.YER_DESTEK) {
                            if (p.fullName.includes('SERKAN KOTAN')) return true; // Force include SERKAN KOTAN
                            if (belongsToSpecificAircraft) return false;
                            
                            const isTechnicalRole = titleUpper.includes('UÇAK TEKNİ') || titleUpper.includes('MÜHENDİS');
                            if (isTechnicalRole) return false;

                            const isGroundRole = [Role.DRIVER, Role.CLEANING, Role.KITCHEN, Role.TEA_SERVICE, Role.OTHER].includes(role);
                            const isGroundTitle = titleUpper.includes('MEMUR') || titleUpper.includes('İŞÇİ') || titleUpper.includes('ŞÖFÖR');
                            return isGroundRole || isGroundTitle;
                        } else if (selModel === AircraftModel.TEKNIK_EKIP) {
                            if (p.fullName.includes('SERKAN KOTAN')) return false; // Force exclude SERKAN KOTAN
                            if (belongsToSpecificAircraft) return false;
                            return titleUpper.includes('UÇAK TEKNİ') || titleUpper.includes('MÜHENDİS');
                        } else if (selModel === AircraftModel.IDARI_BIRIM) {
                            return (titleUpper === 'MEMUR' || titleUpper.includes('İDARİ')) && !belongsToSpecificAircraft;
                        } else {
                            const mNameNormalized = selModel.replace(/[^a-zA-Z0-9ğüşıöçĞÜŞİÖÇ]/g, '').toLocaleUpperCase('tr-TR');
                            return tClean.includes(mNameNormalized);
                        }
                    }).sort((a, b) => (a.rank || 999) - (b.rank || 999));

                    setTimeout(() => {
                        setPeople(targetP);
                        setLoading(false);
                    }, 300);
                }
            }, [selModel, allPersonnel, rangeStartDate, rangeEndDate, models]);

            useEffect(() => {
                const next = {};
                const referenceDate = rangeStartDate;
                const dObj = new Date(referenceDate); 
                const isWe = dObj.getDay() === 0 || dObj.getDay() === 6;

                people.forEach(p => {
                    const r = allRecs.find(x => x.personId === p.id && x.date === referenceDate);
                    
                    // Check for weekend inclusion history (look at Saturday record of this specific week)
                    let hasWeekendRecord = false;
                    if (rangeStartDate !== rangeEndDate) { // Weekly view
                         // Find Saturday of this specific week
                         const [y, m, d] = referenceDate.split('-').map(Number);
                         const current = new Date(y, m-1, d, 12,0,0);
                         const dayOfWeek = current.getDay();
                         const diffToSat = 6 - dayOfWeek; // Days until Saturday
                         const satDate = new Date(current);
                         satDate.setDate(current.getDate() + diffToSat);
                         const satStr = normalizeDate(satDate);
                         
                         const satRec = allRecs.find(x => x.personId === p.id && x.date === satStr);
                         // If Saturday has a record that matches criteria
                         if (satRec) {
                             if (satRec.status === AttendanceStatus.DUTY) {
                                 hasWeekendRecord = true;
                             }
                             if (satRec.status === AttendanceStatus.LEAVE && satRec.leaveType === LeaveType.OVERTIME) {
                                 hasWeekendRecord = true;
                             }
                         }
                    }

                    if (r) {
                        next[p.id] = {
                            ...r,
                            leaveType: r.leaveType || LeaveType.DAILY,
                            dutyType: r.dutyType || DutyType.PLANNED,
                            includeWeekend: hasWeekendRecord
                        };
                    } else {
                        const hist = allRecs.filter(x => x.personId === p.id && x.date < referenceDate).sort((a, b) => b.date.localeCompare(a.date))[0];
                        if (isWe) {
                            if (hist && hist.status === AttendanceStatus.DUTY && hist.dutyType === DutyType.PLANNED) {
                                next[p.id] = { status: hist.status, dutyLocation: hist.dutyLocation, dutyType: hist.dutyType, includeWeekend: hasWeekendRecord };
                            } else {
                                next[p.id] = { status: undefined };
                            }
                        } else {
                            if (hist && referenceDate >= getTodayString()) {
                                // KRİTİK DÜZELTME: İzin, Rapor gibi durumların sonsuza kadar taşınmasını engelle
                                const carryOverStatuses = [AttendanceStatus.PRESENT, AttendanceStatus.DUTY];
                                if (carryOverStatuses.includes(hist.status)) {
                                    next[p.id] = {
                                        ...hist,
                                        leaveType: hist.leaveType || LeaveType.DAILY,
                                        dutyType: hist.dutyType || DutyType.PLANNED,
                                        includeWeekend: hasWeekendRecord
                                    };
                                } else {
                                    // İzin, Rapor, Kurs vb. durumlar bittiyse otomatik olarak Mesai'ye dön
                                    next[p.id] = { status: AttendanceStatus.PRESENT, includeWeekend: hasWeekendRecord };
                                }
                            } else {
                                next[p.id] = { status: AttendanceStatus.PRESENT, includeWeekend: hasWeekendRecord };
                            }
                        }
                    }
                });
                setAtt(next);
            }, [people, allRecs, rangeStartDate]);

            const save = async () => {
                setLoading(true);

                const days = getDaysInRange(rangeStartDate, rangeEndDate);
                const dayStrings = days.map(d => normalizeDate(d));
                const isWeeklyMode = rangeStartDate !== rangeEndDate;

                // Determine which people have "mixed/detailed" records (Blurred rows)
                // We must skip saving for them to prevent overwriting detailed data with bulk data.
                const personsToSkip = new Set();
                if (isWeeklyMode) {
                    people.forEach(p => {
                        const recordsInRange = days.map(d => {
                            const checkDate = normalizeDate(d);
                            return allRecs.find(r => r.personId === p.id && r.date === checkDate);
                        }).filter(r => !!r);

                        if (recordsInRange.length > 0) {
                            if (recordsInRange.length < days.length) {
                                personsToSkip.add(p.id); // Partial data -> Blurred
                            } else {
                                const firstRec = recordsInRange[0];
                                const isUniform = recordsInRange.every(r => 
                                    r.status === firstRec.status &&
                                    r.dutyType === firstRec.dutyType &&
                                    r.dutyLocation === firstRec.dutyLocation &&
                                    r.leaveType === firstRec.leaveType &&
                                    r.note === firstRec.note
                                );
                                if (!isUniform) personsToSkip.add(p.id); // Mixed data -> Blurred
                            }
                        }
                    });
                }

                const recs = [];
                let counter = 0;
                const timestamp = Date.now();

                days.forEach(dateObj => {
                    const dStr = normalizeDate(dateObj);
                    const dayOfWeek = dateObj.getDay();
                    const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                    
                    // Logic to detect if we are unsetting an FMI or Weekend Duty on Friday
                    // If so, we must clean up Sat/Sun records if they exist.
                    const isFriday = dayOfWeek === 5;

                    people.forEach(p => {
                        if (personsToSkip.has(p.id)) return; // Skip blurred rows

                        const s = att[p.id];
                        if (!s?.status) return;

                        const dType = s.dutyType || DutyType.PLANNED;
                        
                        const isPlannedDuty = s.status === AttendanceStatus.DUTY && dType === DutyType.PLANNED;
                        const isOvertimeLeave = s.status === AttendanceStatus.LEAVE && s.leaveType === LeaveType.OVERTIME;
                        
                        // Condition to extend to weekend (Friday + 2 days logic) AND condition to skip weekend if not checked
                        const shouldIncludeWeekend = isPlannedDuty || isOvertimeLeave;

                        if (isWeekend && shouldIncludeWeekend && !s.includeWeekend) {
                             return;
                        }
                        
                        // FMI / Duty Auto-Cleanup Logic for Friday
                        if (isFriday) {
                             // If user is NOT selecting "Include Weekend", but there might be existing weekend records
                             // Or if status changed away from Duty/FMI
                             // We should check and overwrite weekend with PRESENT (default reset)
                             
                             // Calculate Sat/Sun dates
                             const satDate = new Date(dateObj); satDate.setDate(satDate.getDate() + 1); const satStr = normalizeDate(satDate);
                             const sunDate = new Date(dateObj); sunDate.setDate(sunDate.getDate() + 2); const sunStr = normalizeDate(sunDate);
                             
                             // Check if existing records have FMI or Planned Duty
                             const existingSat = allRecs.find(r => r.personId === p.id && r.date === satStr);
                             const existingSun = allRecs.find(r => r.personId === p.id && r.date === sunStr);
                             
                             const hasWeekendJunk = (existingSat && (existingSat.status === AttendanceStatus.DUTY || (existingSat.status === AttendanceStatus.LEAVE && existingSat.leaveType === LeaveType.OVERTIME))) ||
                                                    (existingSun && (existingSun.status === AttendanceStatus.DUTY || (existingSun.status === AttendanceStatus.LEAVE && existingSun.leaveType === LeaveType.OVERTIME)));

                             if (hasWeekendJunk && (!shouldIncludeWeekend || !s.includeWeekend)) {
                                 // Add cleanup records
                                 counter++;
                                 recs.push({
                                    id: `${timestamp}-${counter}-cleanup-sat-${p.id}`,
                                    date: satStr,
                                    personId: p.id,
                                    status: AttendanceStatus.PRESENT, // Reset to Present
                                    aircraftTypeSnapshot: selModel || undefined
                                 });
                                 counter++;
                                 recs.push({
                                    id: `${timestamp}-${counter}-cleanup-sun-${p.id}`,
                                    date: sunStr,
                                    personId: p.id,
                                    status: AttendanceStatus.PRESENT, // Reset to Present
                                    aircraftTypeSnapshot: selModel || undefined
                                 });
                             }
                        }

                        counter++;
                        recs.push({
                            id: `${timestamp}-${counter}-${p.id}`,
                            date: dStr,
                            personId: p.id,
                            status: s.status,
                            dutyLocation: s.dutyLocation,
                            leaveType: s.leaveType,
                            note: s.note,
                            dutyType: dType,
                            aircraftTypeSnapshot: selModel || undefined
                        });

                        if (dayOfWeek === 5 && shouldIncludeWeekend && s.includeWeekend) {
                            const satDate = new Date(dateObj);
                            satDate.setDate(satDate.getDate() + 1);
                            const satStr = normalizeDate(satDate);

                            const sunDate = new Date(dateObj);
                            sunDate.setDate(sunDate.getDate() + 2);
                            const sunStr = normalizeDate(sunDate);

                            const isSatInSelection = dayStrings.includes(satStr);
                            const isSunInSelection = dayStrings.includes(sunStr);

                            if (!isSatInSelection) {
                                counter++;
                                recs.push({
                                    id: `${timestamp}-${counter}-${p.id}`,
                                    date: satStr,
                                    personId: p.id,
                                    status: s.status,
                                    dutyLocation: s.dutyLocation,
                                    leaveType: s.leaveType,
                                    note: s.note,
                                    dutyType: dType,
                                    aircraftTypeSnapshot: selModel || undefined
                                });
                            }

                            if (!isSunInSelection) {
                                counter++;
                                recs.push({
                                    id: `${timestamp}-${counter}-${p.id}`,
                                    date: sunStr,
                                    personId: p.id,
                                    status: s.status,
                                    dutyLocation: s.dutyLocation,
                                    leaveType: s.leaveType,
                                    note: s.note,
                                    dutyType: dType,
                                    aircraftTypeSnapshot: selModel || undefined
                                });
                            }
                        }
                    });
                });

                if (recs.length === 0) {
                    setLoading(false);
                    alert('Kaydedilecek yeni veri yok.');
                    return;
                }

                try {
                    await storageService.saveAttendance(recs);
                    await storageService.refresh();
                    await loadDashboardData();
                    const freshRecs = storageService.getAttendanceSync();
                    setAllRecs(freshRecs);
                    alert('Kaydedildi');
                } catch (e) {
                    console.error("Save Error", e);
                    alert('Kayıt sırasında bir hata oluştu.');
                } finally {
                    setLoading(false);
                }
            };

            const handleAttendanceChange = (pid, status) => {
                setAtt(prev => ({ 
                    ...prev, 
                    [pid]: { 
                        ...prev[pid], 
                        status, 
                        dutyType: status === AttendanceStatus.DUTY ? (prev[pid]?.dutyType || DutyType.PLANNED) : undefined,
                        dutyLocation: (status === AttendanceStatus.DUTY || status === AttendanceStatus.COURSE) ? (prev[pid]?.dutyLocation || 'Ankara') : undefined 
                    } 
                }));
            };

            const handleDetailChange = (pid, field, value) => {
                setAtt(prev => ({ ...prev, [pid]: { ...prev[pid], [field]: value } }));
            };

            // SECURITY WRAPPERS
            const handleUnlock = (e) => {
                e.preventDefault();
                if (unlockPassword === '1839') {
                    setIsEditUnlocked(true);
                    setShowUnlockModal(false);
                    if (pendingAction) {
                        pendingAction();
                        setPendingAction(null);
                    }
                } else {
                    alert('Hatalı şifre!');
                }
            };

            const handleStatusChangeWithAuth = (pid, status) => {
                if (isEditUnlocked) {
                    handleAttendanceChange(pid, status);
                } else {
                    setPendingAction(() => () => handleAttendanceChange(pid, status));
                    setShowUnlockModal(true);
                }
            };

            const handleDetailChangeWithAuth = (pid, field, value) => {
                if (isEditUnlocked) {
                    handleDetailChange(pid, field, value);
                } else {
                    setPendingAction(() => () => handleDetailChange(pid, field, value));
                    setShowUnlockModal(true);
                }
            };

            const openDetailModalWithAuth = (person) => {
                if (isEditUnlocked) {
                    openDetailModal(person);
                } else {
                    setPendingAction(() => () => openDetailModal(person));
                    setShowUnlockModal(true);
                }
            };

            const openDetailModal = (person) => {
                setDetailPerson(person);
                const days = getDaysInRange(rangeStartDate, rangeEndDate);
                const initialStates = {};

                days.forEach(d => {
                    const dStr = normalizeDate(d);
                    const r = allRecs.find(rec => rec.personId === person.id && rec.date === dStr);
                    const isWe = d.getDay() === 0 || d.getDay() === 6;

                    if (r) {
                        initialStates[dStr] = { ...r };
                    } else {
                        const prevDate = new Date(d); prevDate.setDate(prevDate.getDate() - 1);
                        const prevStr = normalizeDate(prevDate);
                        const prevRec = initialStates[prevStr] || allRecs.find(rec => rec.personId === person.id && rec.date === prevStr);

                        if (isWe) {
                            if (prevRec && prevRec.status === AttendanceStatus.DUTY && prevRec.dutyType === DutyType.PLANNED) {
                                initialStates[dStr] = { ...prevRec, id: undefined };
                            } else {
                                initialStates[dStr] = { status: undefined };
                            }
                        } else {
                            if (prevRec) initialStates[dStr] = { ...prevRec, id: undefined };
                            else initialStates[dStr] = { status: AttendanceStatus.PRESENT };
                        }
                    }
                });
                setDetailDays(initialStates);
                setDetailModalOpen(true);
            };

            const handleModalDayChange = (dateStr, field, value) => {
                setDetailDays(prev => ({
                    ...prev,
                    [dateStr]: { ...prev[dateStr], [field]: value }
                }));
            };

            const handleModalStatusChange = (dateStr, status) => {
                setDetailDays(prev => ({
                    ...prev,
                    [dateStr]: {
                        ...prev[dateStr],
                        status,
                        dutyLocation: (status === AttendanceStatus.DUTY || status === AttendanceStatus.COURSE) ? (prev[dateStr]?.dutyLocation || 'Ankara') : undefined,
                        dutyType: status === AttendanceStatus.DUTY ? (prev[dateStr]?.dutyType || DutyType.PLANNED) : undefined,
                        leaveType: status === AttendanceStatus.LEAVE ? (prev[dateStr]?.leaveType || LeaveType.DAILY) : undefined
                    }
                }));
            };

            const saveModal = async () => {
                if (!detailPerson) return;
                setLoading(true);
                const recs = [];
                let counter = 0;
                const timestamp = Date.now();
                
                Object.keys(detailDays).forEach(dStr => {
                    const s = detailDays[dStr];
                    if (s.status) {
                        counter++;
                        recs.push({
                            id: `${timestamp}-${counter}-${detailPerson.id}`,
                            date: dStr,
                            personId: detailPerson.id,
                            status: s.status,
                            dutyLocation: s.dutyLocation,
                            leaveType: s.leaveType,
                            note: s.note,
                            dutyType: s.dutyType,
                            aircraftTypeSnapshot: selModel || undefined
                        });
                    }
                });

                try {
                    await storageService.saveAttendance(recs);
                    await storageService.refresh();
                    await loadDashboardData();
                    const freshRecs = storageService.getAttendanceSync();
                    setAllRecs(freshRecs);
                    alert('Kaydedildi');
                } catch(e) {
                    console.error(e);
                    alert('Kayıt hatası');
                } finally {
                    setDetailModalOpen(false);
                    setDetailPerson(null);
                    setLoading(false);
                }
            };

            const exportExcel = async (isDaily = false) => {
               setLoading(true);
                try {
                    const freshRecs = storageService.getAttendanceSync();
                    const finalPersonnel = await storageService.getPersonnelSync();
                    const aircraftList = await storageService.getAircraft();
                    const unitOrder = ["BELL-429", "C-650", "B-360", "T-70", "AT-802", "TEKNİK EKİP", "YER DESTEK", "İDARİ"];
                    const fUK = (p) => {
                        if (p.unit && unitOrder.includes(p.unit)) return p.unit;
                        const titleUpper = (p.title || '').toLocaleUpperCase('tr-TR');
                        if (titleUpper.includes('BELL')) return "BELL-429";
                        if (titleUpper.includes('C-650')) return "C-650";
                        if (titleUpper.includes('B-360')) return "B-360";
                        if (titleUpper.includes('T-70')) return "T-70";
                        if (titleUpper.includes('AT-802')) return "AT-802";
                        if (titleUpper.includes('TEKNİ') || titleUpper.includes('MÜHENDİS')) return "TEKNİK EKİP";
                        if (titleUpper.includes('MEMUR') || titleUpper.includes('İŞÇİ') || titleUpper.includes('ŞÖFÖR') || [Role.DRIVER, Role.CLEANING, Role.KITCHEN, Role.TEA_SERVICE, Role.OTHER].includes(p.role)) return "İDARİ";
                        return "İDARİ";
                    };
                    let targetP = [...finalPersonnel];
                    const startDateForFilter = isDaily ? getTodayString() : dates.start, endDateForFilter = isDaily ? getTodayString() : dates.end;
                    targetP = targetP.filter(p => !(p.activeUntil && p.activeUntil < startDateForFilter) && !(p.activeFrom && p.activeFrom > endDateForFilter));
                    targetP.sort((a, b) => { const uA = fUK(a); const uB = fUK(b); let idxA = unitOrder.indexOf(uA); let idxB = unitOrder.indexOf(uB); if (idxA === -1) idxA = unitOrder.length; if (idxB === -1) idxB = unitOrder.length; return idxA !== idxB ? idxA - idxB : (a.rank || 999) - (b.rank || 999); });
                    let days = [];
                    if (isDaily) { days.push(new Date(getTodayString().split('-')[0], getTodayString().split('-')[1]-1, getTodayString().split('-')[2], 12,0,0)); }
                    else { let current = new Date(dates.start.split('-')[0], dates.start.split('-')[1]-1, dates.start.split('-')[2], 12,0,0), end = new Date(dates.end.split('-')[0], dates.end.split('-')[1]-1, dates.end.split('-')[2], 12,0,0); while(current <= end) { days.push(new Date(current)); current.setDate(current.getDate() + 1); } }
                    const uniqueAbsentIds = new Set();
                    const beyanList = []; const addedPeriods = new Set();
                    targetP.forEach(p => {
                        days.forEach(d => {
                            const dStr = normalizeDate(d), r = freshRecs.find(x => x.personId === p.id && x.date === dStr);
                            const absenceStates = [AttendanceStatus.LEAVE, AttendanceStatus.SICK, AttendanceStatus.HOSPITAL, AttendanceStatus.PUBLIC_HOLIDAY, AttendanceStatus.OTHER, AttendanceStatus.ABSENT];
                            if (r && absenceStates.includes(r.status)) {
                                uniqueAbsentIds.add(p.id);
                                const pRecs = freshRecs.filter(x => x.personId === p.id).sort((a,b) => a.date.localeCompare(b.date));
                                let curIdx = pRecs.findIndex(x => x.date === dStr);
                                let sI = curIdx; while(sI > 0 && absenceStates.includes(pRecs[sI-1].status)) sI--;
                                let eI = curIdx; while(eI < pRecs.length - 1 && absenceStates.includes(pRecs[eI+1].status)) eI++;
                                const rStart = pRecs[sI].date, rEnd = pRecs[eI].date, key = `${p.id}-${rStart}-${rEnd}`;
                                if (!addedPeriods.has(key)) {
                                    addedPeriods.add(key); let totalG = 0; let hasR = false;
                                    for(let k = sI; k <= eI; k++) { totalG += (pRecs[k].leaveType === LeaveType.HALF_DAY || pRecs[k].leaveType === LeaveType.HALF_OVERTIME ? 0.5 : 1); if(pRecs[k].status === AttendanceStatus.SICK || pRecs[k].status === AttendanceStatus.HOSPITAL) hasR = true; }
                                    let turL = r.status === AttendanceStatus.LEAVE ? r.leaveType : r.status; if(hasR) turL = pRecs.slice(sI, eI+1).find(x => x.status === AttendanceStatus.SICK || x.status === AttendanceStatus.HOSPITAL).status === AttendanceStatus.SICK ? 'RAPOR' : 'HASTANE';
                                    beyanList.push({ ad: p.fullName, birim: fUK(p), tur: turL, start: rStart, end: rEnd, gun: totalG });
                                }
                            }
                        });
                    });
                    const totalFixed = targetP.length, gayriMevcutCount = uniqueAbsentIds.size, hazirCount = totalFixed - gayriMevcutCount;
                    const allCols = [{ key: 'w', label: 'X' }, { key: 'ht', label: 'HT' }, { key: 'yi', label: 'Yİ' }, { key: 'mi', label: 'Mİ' }, { key: 'gi', label: 'Gİ' }, { key: 'ygi', label: 'YGİ' }, { key: 'fmi', label: 'FMİ' }, { key: 'yfmi', label: 'YFMİ' }, { key: 'rt', label: 'İİ' }, { key: 'r', label: 'R' }, { key: 'h', label: 'H' }, { key: 'k', label: 'K' }, { key: 'ot', label: 'D' }];
                    const stats = targetP.map(p => {
                        let s = { w: 0, gp: 0, gu: 0, ht: 0, yi: 0, mi: 0, gi: 0, ygi: 0, fmi: 0, yfmi: 0, rt: 0, r: 0, h: 0, k: 0, ot: 0 };
                        days.forEach(d => {
                            const dStr = normalizeDate(d), r = freshRecs.find(x => x.personId === p.id && x.date === dStr), isWe = d.getDay() === 0 || d.getDay() === 6;
                            if (!((p.activeUntil && dStr > p.activeUntil) || (p.activeFrom && dStr < p.activeFrom))) {
                                if (r) {
                                    if (r.status === AttendanceStatus.PRESENT) { if (isWe) s.ht++; else s.w++; }
                                    else if (r.status === AttendanceStatus.DUTY) { if (r.dutyType === DutyType.UNPLANNED) s.gu++; else s.gp++; }
                                    else if (r.status === AttendanceStatus.COURSE) s.k++;
                                    else if (r.status === AttendanceStatus.SICK) s.r++;
                                    else if (r.status === AttendanceStatus.HOSPITAL) s.h++;
                                    else if (r.status === AttendanceStatus.LEAVE) {
                                        if (r.leaveType === LeaveType.ANNUAL) s.yi++; else if (r.leaveType === LeaveType.EXCUSE) s.mi++; else if (r.leaveType === LeaveType.DAILY) s.gi++;
                                        else if (r.leaveType === LeaveType.HALF_DAY) { s.ygi += 0.5; s.w += 0.5; }
                                        else if (r.leaveType === LeaveType.HALF_OVERTIME) { s.yfmi += 0.5; s.w += 0.5; }
                                        else if (r.leaveType === LeaveType.OVERTIME) s.fmi++;
                                    } else if (r.status === AttendanceStatus.PUBLIC_HOLIDAY) s.rt++;
                                    else if (r.status === AttendanceStatus.OTHER) s.ot++;
                                } else { if (isWe) s.ht++; else s.w++; }
                            }
                        });
                        return { id: p.id, s };
                    });
                    const activeCols = allCols.filter(c => stats.some(st => st.s[c.key] > 0));
                    const fmt = (n) => n === 0 ? '' : String(n).replace('.', ',');
                    const hStyle = 'style="background-color: #c6e0b4; font-weight: bold; text-align: center; border: 1px solid #000;"', cStyle = 'style="border: 1px solid #000; text-align: center; mso-number-format:\'\@\';"', nStyle = 'style="border: 1px solid #000; text-align: left;"', rbStyle = 'style="border: 1px solid #000; text-align: center; color: #ff0000; font-weight: bold; mso-number-format:\'\@\';"';
                    let html = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><meta charset="UTF-8"><meta http-equiv="content-type" content="application/vnd.ms-excel; charset=UTF-8"></head><body>';
                    html += '<table border="1" style="border-collapse: collapse; font-family: Calibri;">';
                    html += `<tr><td colspan="3" ${hStyle}>${days[0].toLocaleDateString('tr-TR', { month: 'long', year: 'numeric' }).toLocaleUpperCase('tr-TR')}</td>`;
                    days.forEach(d => html += `<td ${hStyle}>${String(d.getDate()).padStart(2, '0')}-${String(d.getMonth() + 1).padStart(2, '0')}-${d.getFullYear()}</td>`);
                    activeCols.forEach(c => html += `<td ${hStyle}>${c.label}</td>`); html += `<td ${hStyle}>TOPLAM</td></tr>`;
                    html += `<tr><td ${hStyle}>SIRA</td><td colspan="2" ${hStyle}>AD SOYADI</td>`;
                    days.forEach(d => html += `<td ${hStyle}>${d.toLocaleDateString('tr-TR', { weekday: 'long' }).toLocaleUpperCase('tr-TR')}</td>`);
                    activeCols.forEach(() => html += `<td ${hStyle}></td>`); html += `<td ${hStyle}></td></tr>`;
                    let lastUnit = null;
                    targetP.forEach((p, i) => {
                        const pUnit = fUK(p);
                        if (pUnit !== lastUnit) {
                            html += `<tr><td colspan="${3 + days.length + activeCols.length + 1}" style="background-color: #228b22; color: white; font-weight: bold; text-align: left; border: 1px solid #000; padding: 5px;">${pUnit}</td></tr>`;
                            lastUnit = pUnit;
                        }
                        const s = stats.find(st => st.id === p.id).s;
                        html += `<tr><td ${cStyle}>${i + 1}</td><td colspan="2" ${nStyle}>${p.fullName}</td>`;
                        days.forEach(d => {
                            const dStr = normalizeDate(d), r = freshRecs.find(x => x.personId === p.id && x.date === dStr), isWe = d.getDay() === 0 || d.getDay() === 6;
                            let ct = isWe ? 'HT' : 'X';
                            if (p.activeUntil && dStr > p.activeUntil) ct = 'İ.K'; else if (p.activeFrom && dStr < p.activeFrom) ct = 'P.YOK';
                            else if (r && r.status !== AttendanceStatus.PRESENT) {
                                if (r.status === AttendanceStatus.DUTY || r.status === AttendanceStatus.COURSE) ct = (r.dutyLocation || (r.status === AttendanceStatus.COURSE ? 'KURS' : 'GÖREV')).toLocaleUpperCase('tr-TR');
                                else ct = r.status === AttendanceStatus.LEAVE ? r.leaveType : (r.status === AttendanceStatus.SICK ? 'R' : (r.status === AttendanceStatus.HOSPITAL ? 'H' : (r.status === AttendanceStatus.PUBLIC_HOLIDAY ? 'İ.İ.' : r.status)));
                            }
                            html += `<td ${r && ![AttendanceStatus.PRESENT, AttendanceStatus.DUTY].includes(r.status) ? rbStyle : cStyle}>${ct}</td>`;
                        });
                        activeCols.forEach(col => html += `<td ${cStyle}>${fmt(s[col.key])}</td>`);
                        let totalActive = 0; days.forEach(d => { if (!(p.activeUntil && normalizeDate(d) > p.activeUntil) && !(p.activeFrom && normalizeDate(d) < p.activeFrom)) totalActive++; });
                        html += `<td ${cStyle}>${totalActive}</td></tr>`;
                    });
                    html += `</table><br/><table border="1" style="border-collapse: collapse; width: 350px;"><tr><td colspan="2" ${hStyle}>GENEL ÖZET</td></tr><tr><td ${cStyle} style="text-align:left;">TOPLAM PERSONEL</td><td ${cStyle}>${totalFixed}</td></tr><tr><td ${cStyle} style="text-align:left;">HAZIR</td><td ${cStyle}>${hazirCount}</td></tr><tr><td ${cStyle} style="text-align:left;">GAYRI MEVCUT</td><td ${cStyle}>${gayriMevcutCount}</td></tr></table>`;
                    html += `<br/><table border="1" style="border-collapse: collapse;"><tr><td colspan="6" ${hStyle}>GAYRI MEVCUT BEYANLARI</td></tr><tr><td ${hStyle}>SIRA NO</td><td ${hStyle}>AD SOYAD</td><td ${hStyle}>BİRİM</td><td ${hStyle}>TÜR</td><td ${hStyle}>TARİHLER</td><td ${hStyle}>GÜN SAYISI</td></tr>`;
                    beyanList.forEach((b, idx) => {
                        const fd = (s) => `${s.split('-')[2]}-${s.split('-')[1]}-${s.split('-')[0]}`;
                        html += `<tr><td ${cStyle}>${idx + 1}</td><td ${nStyle}>${b.ad}</td><td ${cStyle}>${b.birim}</td><td ${rbStyle}>${b.tur}</td><td ${cStyle}>${fd(b.start)} / ${fd(b.end)}</td><td ${cStyle}>${fmt(b.gun)}</td></tr>`;
                    });
                    html += `</table><br/><table border="1" style="border-collapse: collapse; width: 450px;"><tr><td colspan="2" ${hStyle}>KISALTMALAR VE AÇIKLAMALARI</td></tr>`;
                    const abbrs = [["X", "MESAİ / HAZIR"], ["HT", "HAFTA TATİLİ"], ["G.İ", "GÜNLÜK İZİN"], ["F.M.İ", "FAZLA MESAİ İZNİ"], ["Yİ", "YILLIK İZİN"], ["M.İ", "MAZERET İZNİ"], ["Y.G.İ", "YARIM GÜN İZİN"], ["RAPOR", "RAPOR"], ["HASTANE", "HASTANE"], ["KURS", "KURS"], ["İDARİ İZİN", "İDARİ İZİN"]];
                    abbrs.forEach(a => html += `<tr><td ${cStyle}>${a[0]}</td><td ${nStyle} style="padding-left:10px;">${a[1]}</td></tr>`);
                    html += '</table></body></html>';
                    const link = document.createElement('a'); link.href = URL.createObjectURL(new Blob(['\uFEFF', html], { type: 'application/vnd.ms-excel;charset=utf-8' }));
                    link.download = `Yoklama_Raporu_${isDaily ? getTodayString() : (dates.start + '_' + dates.end)}.xls`; link.click();
                } catch(e) { alert("Rapor hatası: " + e); } finally { setLoading(false); }
            };

            const renderPersonRow = (p, i) => {
                const s = att[p.id] || {};
                const isWeeklyMode = rangeStartDate !== rangeEndDate;
                let shouldBlur = false;
                if (isWeeklyMode) {
                    const dInR = getDaysInRange(rangeStartDate, rangeEndDate);
                    const rInR = dInR.map(d => { const dStr = normalizeDate(d); return allRecs.find(r => r.personId === p.id && r.date === dStr); }).filter(r => !!r);
                    if (rInR.length > 0) { if (rInR.length < dInR.length) shouldBlur = true; else { const fR = rInR[0]; if (!rInR.every(r => r.status === fR.status && r.dutyType === fR.dutyType && r.dutyLocation === fR.dutyLocation && r.leaveType === fR.leaveType)) shouldBlur = true; } }
                }
                return (
                    <div key={p.id} className="relative group">
                        <div className={`bg-forest-950/40 p-3 rounded border border-forest-800 flex flex-col xl:flex-row gap-4 items-start xl:items-center justify-between transition-all duration-300 ${shouldBlur ? 'opacity-30 blur-[2px] pointer-events-none' : ''}`}>
                            <div className="w-full xl:w-1/4 flex gap-2 items-center">
                                {rangeStartDate !== rangeEndDate && <button onClick={() => openDetailModalWithAuth(p)} className="bg-blue-600 p-1.5 rounded"><CalendarDays size={18} /></button>}
                                <span className="text-forest-500 w-6">{i + 1}</span>
                                <div><div className="text-white font-medium">{p.fullName}</div><div className="text-xs text-forest-400">{p.title || p.role}</div></div>
                            </div>
                            <AttendanceControl personId={p.id} state={s} isWeeklyMode={isWeeklyMode} aircraftModel={selModel} onChangeStatus={handleStatusChangeWithAuth} onChangeDetail={handleDetailChangeWithAuth} />
                        </div>
                        {shouldBlur && <div className="absolute inset-0 flex items-center justify-center"><Button onClick={() => openDetailModalWithAuth(p)}><Edit2 size={16} className="mr-2" /> Düzenle</Button></div>}
                    </div>
                );
            };

             if (loading) return (
                <div className="fixed inset-0 bg-black/80 z-50 flex flex-col items-center justify-center">
                    <div className="w-64 h-64 mb-4 rounded-full border-8 border-forest-400 overflow-hidden shadow-[0_0_40px_rgba(0,0,0,0.6)]">
                        <img src="https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExNW9uenhqZXdxbGd6YWNxc2UwempmOXNyaG15NGtuZTJmb3EyaTNqZCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9cw/1rrxPs1nb3IjwmbiXw/giphy.gif" alt="Loading..." className="w-full h-full object-cover" />
                    </div>
                    <div className="text-white text-xl font-bold animate-pulse">Bekleyiniz</div>
                </div>
            );

            if (!selModel) return (
                <div className="container mx-auto p-4 max-w-5xl space-y-8 animate-fade-in">
                    <h1 className="text-3xl font-bold text-white mb-4">Yoklama Takip</h1>
                    <Card title="Birim Seçiniz">
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                          
                            {models.map(m => {
                                const stat = dashboardStatus[m] || { pilotMissing: false, techMissing: false, groundMissing: false };
                                const hasIssue = stat.pilotMissing || stat.techMissing || stat.groundMissing;
                                return (
                                <button key={m} onClick={() => setSelModel(m)} className={`p-6 rounded border-2 font-bold flex flex-col items-center transition-all group relative overflow-hidden ${!hasIssue ? 'bg-teal-600 border-teal-400 hover:bg-teal-500 text-white' : 'bg-forest-800 border-forest-600 hover:bg-forest-700 text-white'}`}>
                                    <ModelIcon category={inv.find(a => a.model === m)?.category} model={m} className="mb-2" /> {m}
                                    {stat.groundMissing && <span className="text-[10px] bg-red-600 px-2 py-0.5 rounded mt-2 animate-pulse w-full block">YOKLAMA GİRİLMEDİ</span>}
                                    {stat.pilotMissing && <span className="text-[10px] bg-orange-600 px-2 py-0.5 rounded mt-1 animate-pulse w-full block">PİLOT GİRİLMEDİ</span>}
                                    {stat.techMissing && <span className="text-[10px] bg-red-600 px-2 py-0.5 rounded mt-1 animate-pulse w-full block">TEKNİSYEN GİRİLMEDİ</span>}
                                </button>
                            )})}
                        </div>
                    </Card>
                    <Card title="Raporlar ve Çıktılar">
                        <div className="flex flex-col gap-6">
                            <div className="bg-forest-900/80 p-6 rounded-lg border border-forest-600 shadow-md">
                                <h3 className="text-forest-100 font-semibold mb-4 flex items-center gap-2">
                                    <Calendar className="text-forest-400" /> Rapor Filtreleri
                                </h3>
                                
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                     <div>
                                        <label className="text-xs text-forest-400 block mb-1">Birim Seçimi</label>
                                        <select 
                                            className="w-full bg-forest-950 border border-forest-600 text-white rounded p-2 text-sm"
                                            value={reportUnit}
                                            onChange={(e) => setReportUnit(e.target.value)}
                                        >
                                            <option value="TÜM BİRİMLER">TÜM BİRİMLER</option>
                                            <option value="YÖNETİM">YÖNETİM</option>
                                            {models.map(m => <option key={m} value={m}>{m}</option>)}
                                        </select>
                                     </div>
                                     <div>
                                        <label className="text-xs text-forest-400 block mb-1">Personel Arama</label>
                                        <div className="relative">
                                            <Search size={16} className="absolute left-2 top-2.5 text-forest-400"/>
                                            <input 
                                                type="text" 
                                                list="personnel-list"
                                                placeholder="İsim Ara..." 
                                                className="w-full bg-forest-950 border border-forest-600 text-white rounded p-2 pl-8 text-sm"
                                                value={reportSearch}
                                                onChange={(e) => setReportSearch(e.target.value)}
                                            />
                                            <datalist id="personnel-list">
                                                {allPersonnel.map(p => <option key={p.id} value={p.fullName} />)}
                                            </datalist>
                                        </div>
                                     </div>
                                </div>

                                <h3 className="text-forest-100 font-semibold mb-2 flex items-center gap-2 text-sm">
                                    <CalendarDays className="text-forest-400" size={16} /> Tarih Aralığı
                                </h3>
                                <div className="flex flex-wrap items-end gap-4">
                                    <div><label className="text-xs text-forest-400">Başlangıç</label><input type="date" value={dates.start} onChange={e => { setDates({ ...dates, start: e.target.value }); setIsReportReady(false) }} className="bg-forest-950 border border-forest-600 text-white rounded p-2 text-sm" /></div>
                                    <div><label className="text-xs text-forest-400">Bitiş</label><input type="date" value={dates.end} onChange={e => { setDates({ ...dates, end: e.target.value }); setIsReportReady(false) }} className="bg-forest-950 border border-forest-600 text-white rounded p-2 text-sm" /></div>
                                    <Button onClick={() => exportExcel(false)} variant="success">Rapor İndir (EXCEL)</Button>
                                    <div className="h-8 w-px bg-forest-600 mx-2"></div>
                                    <Button onClick={() => exportExcel(true)} className="bg-blue-600 hover:bg-blue-500">Günlük Rapor İndir (BUGÜN)</Button>
                                </div>
                            </div>
                        </div>
                    </Card>
                </div>
            );

            const pilots = people.filter(p => p.role === Role.PİLOT || (p.title && p.title.toLocaleUpperCase('tr-TR').includes('PİLOT')));
            const others = people.filter(p => !pilots.includes(p));
            
            const hasPilots = pilots.length > 0;
            const isGroundUnit = selModel === AircraftModel.YER_DESTEK;
            const isMixedUnit = !isGroundUnit && hasPilots && others.length > 0;

            return (
                <div className="container mx-auto p-4 max-w-6xl animate-fade-in relative">
                    {showUnlockModal && (
                        <div className="fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4">
                            <div className="bg-forest-900 border border-forest-500 p-6 rounded-lg max-w-sm w-full shadow-[0_0_50px_rgba(0,0,0,0.8)] animate-slide-down">
                                <div className="flex flex-col items-center mb-4">
                                    <div className="bg-forest-800 p-3 rounded-full mb-3 border border-forest-600">
                                        <Lock size={32} className="text-forest-400" />
                                    </div>
                                    <h3 className="text-xl font-bold text-white">Düzenleme Kilidi</h3>
                                    <p className="text-sm text-forest-300 text-center mt-2">Değişiklik yapabilmek için lütfen yönetici şifresini giriniz.</p>
                                </div>
                                <form onSubmit={handleUnlock}>
                                    <input 
                                        type="password" 
                                        placeholder="Şifre" 
                                        className="w-full bg-forest-950 border border-forest-600 rounded p-3 text-white mb-4 focus:ring-2 focus:ring-forest-400 focus:outline-none text-center tracking-widest text-lg"
                                        autoFocus
                                        value={unlockPassword}
                                        onChange={(e) => setUnlockPassword(e.target.value)}
                                    />
                                    <div className="flex gap-2">
                                        <Button variant="secondary" type="button" onClick={() => { setShowUnlockModal(false); setPendingAction(null); setUnlockPassword(''); }} className="w-full">İptal</Button>
                                        <Button type="submit" className="w-full">Kilidi Aç</Button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    <div className="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-4 text-white bg-forest-700/50 p-4 rounded border border-forest-600 gap-4 sticky top-4 z-50 shadow-lg backdrop-blur-md bg-forest-700/90">
                        <h2 className="text-xl font-bold flex items-center gap-2"><ModelIcon model={selModel} category={inv.find(a => a.model === selModel)?.category} /> {selModel}</h2>
                        <div className="flex flex-col md:flex-row gap-4 items-end md:items-center w-full md:w-auto">
                            
                            <div className="flex flex-col">
                                <label className="text-[10px] text-forest-400 uppercase font-bold">Tarih Aralığı</label>
                                <div className="flex items-center gap-1">
                                    <input type="date" value={rangeStartDate} onChange={e => setRangeStartDate(e.target.value)} className="bg-forest-900 text-white p-1 rounded border border-forest-500 text-sm w-28" />
                                    <span className="text-forest-500">-</span>
                                    <input type="date" value={rangeEndDate} onChange={e => setRangeEndDate(e.target.value)} className="bg-forest-900 text-white p-1 rounded border border-forest-500 text-sm w-28" />
                                </div>
                            </div>
                            <Button variant="secondary" onClick={handleBackToDashboard} className="h-9">EKRANA DÖN</Button>
                        </div>
                    </div>

                    {rangeStartDate !== rangeEndDate && (
                        <div className="bg-blue-900/40 border border-blue-700 p-3 rounded-lg flex items-center text-blue-200 text-sm mb-4 animate-fade-in justify-between">
                            <div className="flex items-center"><AlertCircle size={16} className="mr-2" />
                                <strong>DİKKAT:</strong> Seçtiğiniz durumlar <strong>{rangeStartDate}</strong> ile <strong>{rangeEndDate}</strong> arasındaki <u>TÜM GÜNLERE</u> uygulanacaktır.</div>
                        </div>
                    )}

                    <Card title="Personel Listesi">
                        <div className="grid gap-4">
                            {isMixedUnit && (
                                <div className="flex gap-4 mb-4 border-b border-forest-600 pb-2">
                                     <button 
                                        onClick={() => setActiveTab('Pilot')}
                                        className={`flex-1 py-3 px-4 rounded-lg flex items-center justify-center gap-2 font-bold transition-all ${
                                            activeTab === 'PİLOT' 
                                            ? 'bg-forest-600 text-white shadow-lg ring-2 ring-forest-400' 
                                            : 'bg-forest-900 text-forest-300 hover:bg-forest-800'
                                        }`}
                                     >
                                         <Plane size={20} /> UÇUŞ EKİBİ (Pilotlar)
                                     </button>
                                     <button 
                                        onClick={() => setActiveTab('TECH')}
                                        className={`flex-1 py-3 px-4 rounded-lg flex items-center justify-center gap-2 font-bold transition-all ${
                                            activeTab === 'TECH' 
                                            ? 'bg-forest-600 text-white shadow-lg ring-2 ring-forest-400' 
                                            : 'bg-forest-900 text-forest-300 hover:bg-forest-800'
                                        }`}
                                     >
                                         <Wrench size={20} /> TEKNİK EKİP
                                     </button>
                                </div>
                            )}

                            {isMixedUnit ? (
                                activeTab === 'PILOT' 
                                    ? pilots.map((p, i) => renderPersonRow(p, i))
                                    : others.map((p, i) => renderPersonRow(p, i))
                            ) : (
                                people.map((p, i) => renderPersonRow(p, i))
                            )}
                        </div>
                    </Card>
                    <div className="sticky bottom-0 bg-forest-950 p-4 border-t border-forest-700 flex justify-center mt-4"><Button size="lg" onClick={save} className="w-full max-md-md">KAYDET ({rangeStartDate !== rangeEndDate ? 'Tüm Aralık' : 'Bugün'})</Button></div>
                    <div className="h-20" />

                    {detailModalOpen && detailPerson && (
                        <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 overflow-auto">
                            <div className="bg-forest-900 border border-forest-600 w-full max-w-4xl rounded-lg shadow-2xl flex flex-col max-h-[90vh]">
                                <div className="p-4 border-b border-forest-700 flex justify-between items-center bg-forest-950">
                                    <div>
                                        <h3 className="text-xl font-bold text-white">{detailPerson.fullName}</h3>
                                        <p className="text-sm text-forest-400">Detaylı Günlük Giriş ({new Date(rangeStartDate).toLocaleDateString('tr-TR')} - {new Date(rangeEndDate).toLocaleDateString('tr-TR')})</p>
                                    </div>
                                    <button onClick={() => { setDetailModalOpen(false); setDetailPerson(null) }}><X size={24} className="text-forest-400 hover:text-white" /></button>
                                </div>
                                <div className="p-4 overflow-y-auto flex-1 space-y-3">
                                    {Object.keys(detailDays).sort().map(dStr => {
                                        const dateObj = new Date(dStr);
                                        const [y, m, d] = dStr.split('-').map(Number);
                                        const noonDate = new Date(y, m-1, d, 12,0,0);
                                        
                                        const dayName = noonDate.toLocaleDateString('tr-TR', { weekday: 'long' });
                                        const isWe = noonDate.getDay() === 0 || noonDate.getDay() === 6;
                                        return (
                                            <div key={dStr} className={`p-3 rounded border ${isWe ? 'bg-forest-800/30 border-forest-700' : 'bg-forest-950/30 border-forest-800'} flex flex-col lg:flex-row items-center gap-4`}>
                                                <div className="w-full lg:w-32 flex-shrink-0 text-center lg:text-left">
                                                    <div className="font-bold text-white">{noonDate.toLocaleDateString('tr-TR')}</div>
                                                    <div className="text-xs text-forest-400 uppercase">{dayName}</div>
                                                </div>
                                                <div className="flex-1 w-full">
                                                    <AttendanceControl
                                                        personId={dStr}
                                                        state={detailDays[dStr]}
                                                        aircraftModel={selModel}
                                                        onChangeStatus={(id, s) => handleModalStatusChange(id, s)}
                                                        onChangeDetail={(id, f, v) => handleModalDayChange(id, f, v)}
                                                    />
                                                </div>
                                            </div>
                                        )
                                    })}
                                </div>
                                <div className="p-4 border-t border-forest-700 bg-forest-950 flex justify-end gap-2">
                                    <Button variant="secondary" onClick={() => { setDetailModalOpen(false); setDetailPerson(null) }}>İptal</Button>
                                    <Button onClick={saveModal}>Bu Kişi İçin Kaydet</Button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const Login = ({ onLogin }) => {
            const [u, setU] = useState(''); 
            const [p, setP] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (u === 'ogm' && p === '1839') {
                    onLogin();
                }
            };

            return (
                <div className="flex items-center justify-center min-h-[50vh]">
                    <Card title="Yönetici Girişi" className="w-full max-w-md">
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <input type="text" placeholder="Kullanıcı Adı" className="w-full bg-forest-950 border border-forest-700 rounded p-2 text-white" value={u} onChange={e => setU(e.target.value)} />
                            <input type="password" placeholder="Parola" className="w-full bg-forest-950 border border-forest-700 rounded p-2 text-white" value={p} onChange={e => setP(e.target.value)} />
                            <Button type="submit" className="w-full">Giriş Yap</Button>
                        </form>
                    </Card>
                </div>
            );
        };

        const App = () => {
            const [view, setView] = useState('attendance');
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [curtainOpen, setCurtainOpen] = useState(false);
            const [curtainHidden, setCurtainHidden] = useState(false);

            useEffect(() => {
                const timer = setTimeout(() => {
                    setCurtainOpen(true);
                    setTimeout(() => setCurtainHidden(true), 1000);
                }, 2000);
                return () => clearTimeout(timer);
            }, []);

            const handleLoginSuccess = () => {
                setIsAuthenticated(true);
                setView('admin');
            };

            const handleLogout = () => {
                setIsAuthenticated(false);
                setView('attendance');
            };

            return (
                <div className="min-h-screen pb-10">
                    <div id="curtain" className={`fixed top-0 left-0 w-full h-full bg-forest-800 z-[9999] flex flex-col items-center justify-center transition-transform duration-1000 ease-in-out ${curtainOpen ? '-translate-y-full' : 'translate-y-0'} ${curtainHidden ? 'hidden' : ''}`}>
                            <div className="w-96 h-96 rounded-full overflow-hidden border-8 border-forest-400 shadow-[0_0_40px_rgba(0,0,0,0.6)] mb-8">
                                <img src="https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExNW9uenhqZXdxbGd6YWNxc2UwempmOXNyaG15NGtuZTJmb3EyaTNqZCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9cw/1rrxPs1nb3IjwmbiXw/giphy.gif" alt="Loading..." className="w-full h-full object-cover" />
                            </div>
                            <h1 className="text-5xl md:text-6xl font-bold text-white tracking-wider text-center px-4">UÇUŞ VE EĞİTİM ŞUBE YOKLAMA</h1>
                        </div>

                    {view === 'attendance' && (
                        <div className="relative">
                            <AttendanceView />
                            <div className="fixed top-4 right-4 z-50">
                                <button
                                    onClick={() => setView('login')}
                                    className="bg-forest-600 hover:bg-forest-500 text-white px-3 py-1.5 text-xs rounded-full border border-forest-500 shadow-md flex items-center gap-1.5 transition-all font-bold tracking-wide"
                                    title="Yönetici Girişi"
                                >
                                    <Settings size={14} />
                                    <span>Yönetici Paneli</span>
                                </button>
                            </div>
                        </div>
                    )}

                    {view === 'login' && (
                        <div className="container mx-auto p-4 animate-fade-in">
                            <button onClick={() => setView('attendance')} className="mb-4 text-forest-400 hover:text-white flex items-center gap-2">
                                <ArrowUp className="rotate-[-90deg]" size={16} /> Geri Dön
                            </button>
                            <Login onLogin={handleLoginSuccess} />
                        </div>
                    )}

                    {view === 'admin' && (
                        isAuthenticated ? (
                            <AdminPanel onLogout={handleLogout} />
                        ) : (
                            <Login onLogin={handleLoginSuccess} />
                        )
                    )}
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

